# å›¾æ–‡ç”Ÿæˆå°ç¨‹åº - åç«¯æœåŠ¡è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.0  
> æ›´æ–°æ—¥æœŸï¼š2026-01-25  
> é¡¹ç›®å®šä½ï¼šä¸ºå›¾æ–‡ç”Ÿæˆå°ç¨‹åºæä¾›å®‰å…¨ã€å¯é ã€é«˜æ€§èƒ½çš„åç«¯æœåŠ¡ï¼Œæ”¯æŒç”¨æˆ·è®¤è¯ã€ä½œå“ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ã€æ¨¡å‹è°ƒç”¨ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ ˆé€‰å‹](#1-æŠ€æœ¯æ ˆé€‰å‹)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [é¡¹ç›®ç»“æ„](#3-é¡¹ç›®ç»“æ„)
4. [æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
5. [API æ¥å£è®¾è®¡](#5-api-æ¥å£è®¾è®¡)
6. [å®‰å…¨è®¾è®¡](#6-å®‰å…¨è®¾è®¡)
7. [æ•°æ®å‡†ç¡®æ€§ä¿éšœ](#7-æ•°æ®å‡†ç¡®æ€§ä¿éšœ)
8. [ä»»åŠ¡é˜Ÿåˆ—ä¸è°ƒåº¦](#8-ä»»åŠ¡é˜Ÿåˆ—ä¸è°ƒåº¦)
9. [éƒ¨ç½²ä¸è¿ç»´](#9-éƒ¨ç½²ä¸è¿ç»´)

---

## 1. æŠ€æœ¯æ ˆé€‰å‹

### 1.1 æ ¸å¿ƒæ¡†æ¶

| æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| **Node.js** | ^20.x LTS | JavaScript è¿è¡Œæ—¶ |
| **NestJS** | ^10.x | ä¼ä¸šçº§ Node.js æ¡†æ¶ï¼Œæ¨¡å—åŒ–ã€ä¾èµ–æ³¨å…¥ |
| **TypeScript** | ^5.x | ç±»å‹å®‰å…¨ |
| **Prisma** | ^5.x | ä¸‹ä¸€ä»£ ORMï¼Œç±»å‹å®‰å…¨ã€è‡ªåŠ¨è¿ç§» |

### 1.2 æ•°æ®å­˜å‚¨

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **PostgreSQL** | ä¸»æ•°æ®åº“ï¼Œå­˜å‚¨ç”¨æˆ·ã€ä½œå“ã€åˆ†ç±»ç­‰ä¸šåŠ¡æ•°æ® |
| **Redis** | ç¼“å­˜ã€ä¼šè¯ã€ä»»åŠ¡é˜Ÿåˆ—ã€åˆ†å¸ƒå¼é” |
| **MinIO / è…¾è®¯ COS** | å¯¹è±¡å­˜å‚¨ï¼Œå­˜å‚¨ç”Ÿæˆå›¾ç‰‡ |

### 1.3 å·¥å…·åº“

| åº“å | ç”¨é€” |
|------|------|
| **Zod** | è¿è¡Œæ—¶ç±»å‹éªŒè¯ä¸ Schema å®šä¹‰ |
| **BullMQ** | åŸºäº Redis çš„ä»»åŠ¡é˜Ÿåˆ— |
| **Passport** | è®¤è¯ä¸­é—´ä»¶ |
| **bcrypt** | å¯†ç å“ˆå¸Œ |
| **helmet** | HTTP å®‰å…¨å¤´ |
| **class-validator** | DTO éªŒè¯ï¼ˆé…åˆ Zodï¼‰ |
| **winston** | æ—¥å¿—è®°å½• |
| **dayjs** | æ—¥æœŸå¤„ç† |

### 1.4 ç±»å‹éªŒè¯ï¼ˆZodï¼‰

åç«¯åŒæ ·ä½¿ç”¨ Zod è¿›è¡Œè¿è¡Œæ—¶ç±»å‹éªŒè¯ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼š

```typescript
import { z } from 'zod';

// API è¯·æ±‚éªŒè¯
export const CreateCategoryDto = z.object({
  name: z.string().min(1, 'åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º').max(50),
  code: z.string().regex(/^[a-z0-9_]+$/, 'ç¼–ç æ ¼å¼é”™è¯¯'),
  type: z.enum(['style', 'model']),
  icon: z.string().optional(),
  cover: z.string().url().optional(),
  description: z.string().max(200).optional(),
  parentId: z.number().int().positive().optional(),
  sort: z.number().int().min(0).default(0),
  status: z.union([z.literal(0), z.literal(1)]).default(1),
});

export type CreateCategoryInput = z.infer<typeof CreateCategoryDto>;

// ç¯å¢ƒå˜é‡éªŒè¯
export const EnvSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']),
  PORT: z.string().transform(Number).pipe(z.number().min(1).max(65535)),
  DATABASE_URL: z.string().url(),
  REDIS_URL: z.string().url(),
  JWT_SECRET: z.string().min(32, 'JWT_SECRET è‡³å°‘32ä½'),
  JWT_EXPIRES_IN: z.string().default('7d'),
});
```

### 1.5 ä»£ç è§„èŒƒ

| å·¥å…· | è¯´æ˜ |
|------|------|
| **ESLint** | ä»£ç æ£€æŸ¥ |
| **Prettier** | ä»£ç æ ¼å¼åŒ– |
| **husky** | Git hooks |
| **commitlint** | æäº¤ä¿¡æ¯è§„èŒƒ |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   å¾®ä¿¡å°ç¨‹åº    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚ HTTPS
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Nginx / è´Ÿè½½å‡è¡¡                             â”‚
â”‚                        (SSL ç»ˆæ­¢ã€è¯·æ±‚è½¬å‘ã€é™æ€èµ„æº)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚                            â”‚
        â–¼                            â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server  â”‚          â”‚   API Server  â”‚          â”‚   API Server  â”‚
â”‚   (NestJS)    â”‚          â”‚   (NestJS)    â”‚          â”‚   (NestJS)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          â”‚                          â”‚
        â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL   â”‚          â”‚     Redis     â”‚          â”‚  å¯¹è±¡å­˜å‚¨     â”‚
â”‚   (ä¸»æ•°æ®åº“)   â”‚          â”‚ (ç¼“å­˜/é˜Ÿåˆ—)   â”‚          â”‚ (MinIO/COS)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  Task Worker  â”‚
                          â”‚  (BullMQ)     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  AI æ¨¡å‹æœåŠ¡   â”‚
                          â”‚ (SDXL/Flux)   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              NestJS Application                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Auth      â”‚   User      â”‚   Category  â”‚   Works     â”‚   Task         â”‚
â”‚   Module    â”‚   Module    â”‚   Module    â”‚   Module    â”‚   Module       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Â· å¾®ä¿¡ç™»å½•   â”‚ Â· ç”¨æˆ·ç®¡ç†   â”‚ Â· åˆ†ç±»ç®¡ç†   â”‚ Â· ä½œå“ç®¡ç†   â”‚ Â· ä»»åŠ¡é˜Ÿåˆ—     â”‚
â”‚ Â· JWT è®¤è¯  â”‚ Â· ä¼šå‘˜ç®¡ç†   â”‚ Â· é£æ ¼ç®¡ç†   â”‚ Â· å®¡æ ¸ç®¡ç†   â”‚ Â· ç”Ÿæˆè°ƒåº¦     â”‚
â”‚ Â· æƒé™æ§åˆ¶   â”‚ Â· é¢åº¦ç®¡ç†   â”‚ Â· æ¨¡å‹ç®¡ç†   â”‚ Â· ä¸‹è½½ç»Ÿè®¡   â”‚ Â· çŠ¶æ€è¿½è¸ª     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼               â–¼               â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Common  â”‚   â”‚  Shared  â”‚   â”‚  Config  â”‚
              â”‚  Module  â”‚   â”‚  Module  â”‚   â”‚  Module  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. é¡¹ç›®ç»“æ„

```
server/
â”œâ”€â”€ prisma/                      # Prisma ORM
â”‚   â”œâ”€â”€ schema.prisma           # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ migrations/             # è¿ç§»æ–‡ä»¶
â”‚   â””â”€â”€ seed.ts                 # ç§å­æ•°æ®
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                 # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ app.module.ts           # æ ¹æ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                 # é€šç”¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ decorators/         # è‡ªå®šä¹‰è£…é¥°å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ public.decorator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ roles.decorator.ts
â”‚   â”‚   â”‚   â””â”€â”€ current-user.decorator.ts
â”‚   â”‚   â”œâ”€â”€ filters/            # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ http-exception.filter.ts
â”‚   â”‚   â”‚   â””â”€â”€ prisma-exception.filter.ts
â”‚   â”‚   â”œâ”€â”€ guards/             # å®ˆå«
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt-auth.guard.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ roles.guard.ts
â”‚   â”‚   â”‚   â””â”€â”€ throttle.guard.ts
â”‚   â”‚   â”œâ”€â”€ interceptors/       # æ‹¦æˆªå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ logging.interceptor.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ transform.interceptor.ts
â”‚   â”‚   â”‚   â””â”€â”€ timeout.interceptor.ts
â”‚   â”‚   â”œâ”€â”€ pipes/              # ç®¡é“
â”‚   â”‚   â”‚   â””â”€â”€ zod-validation.pipe.ts
â”‚   â”‚   â””â”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚   â”‚       â”œâ”€â”€ logger.middleware.ts
â”‚   â”‚       â””â”€â”€ security.middleware.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                 # é…ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config.module.ts
â”‚   â”‚   â”œâ”€â”€ config.service.ts
â”‚   â”‚   â”œâ”€â”€ database.config.ts
â”‚   â”‚   â”œâ”€â”€ redis.config.ts
â”‚   â”‚   â”œâ”€â”€ jwt.config.ts
â”‚   â”‚   â””â”€â”€ env.validation.ts   # ç¯å¢ƒå˜é‡ Zod éªŒè¯
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                # ä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/               # è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ wechat.strategy.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login.dto.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ refresh-token.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ schemas/        # Zod Schemas
â”‚   â”‚   â”‚       â””â”€â”€ auth.schema.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ user/               # ç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ user.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ user.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ user.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ schemas/
â”‚   â”‚   â”‚       â””â”€â”€ user.schema.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ category/           # åˆ†ç±»æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ category.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ category.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ category.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ schemas/
â”‚   â”‚   â”‚       â””â”€â”€ category.schema.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ works/              # ä½œå“æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ works.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ works.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ works.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ schemas/
â”‚   â”‚   â”‚       â””â”€â”€ works.schema.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ task/               # ä»»åŠ¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ task.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ task.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ task.processor.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ schemas/
â”‚   â”‚   â”‚       â””â”€â”€ task.schema.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ admin/              # åå°ç®¡ç†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ schemas/
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ storage/            # å­˜å‚¨æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ storage.module.ts
â”‚   â”‚       â”œâ”€â”€ storage.service.ts
â”‚   â”‚       â””â”€â”€ strategies/
â”‚   â”‚           â”œâ”€â”€ minio.strategy.ts
â”‚   â”‚           â””â”€â”€ cos.strategy.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                 # å…±äº«æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ prisma/             # Prisma æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ prisma.module.ts
â”‚   â”‚   â”‚   â””â”€â”€ prisma.service.ts
â”‚   â”‚   â”œâ”€â”€ redis/              # Redis æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ redis.module.ts
â”‚   â”‚   â”‚   â””â”€â”€ redis.service.ts
â”‚   â”‚   â”œâ”€â”€ logger/             # æ—¥å¿—æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.module.ts
â”‚   â”‚   â”‚   â””â”€â”€ logger.service.ts
â”‚   â”‚   â””â”€â”€ cache/              # ç¼“å­˜æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ cache.module.ts
â”‚   â”‚       â””â”€â”€ cache.service.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ crypto.util.ts      # åŠ å¯†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ hash.util.ts        # å“ˆå¸Œå·¥å…·
â”‚   â”‚   â”œâ”€â”€ mask.util.ts        # è„±æ•å·¥å…·
â”‚   â”‚   â””â”€â”€ validate.util.ts    # éªŒè¯å·¥å…·
â”‚   â”‚
â”‚   â””â”€â”€ types/                  # TypeScript ç±»å‹
â”‚       â”œâ”€â”€ common.d.ts
â”‚       â”œâ”€â”€ express.d.ts
â”‚       â””â”€â”€ env.d.ts
â”‚
â”œâ”€â”€ test/                       # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ e2e/
â”‚   â””â”€â”€ unit/
â”‚
â”œâ”€â”€ .env                        # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .prettierrc
â”œâ”€â”€ docker-compose.yml          # Docker ç¼–æ’
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ nest-cli.json
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚       â”‚    Works    â”‚       â”‚  Category   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          â”‚â”€â”€â”    â”‚ id          â”‚    â”Œâ”€â”€â”‚ id          â”‚
â”‚ openid      â”‚  â”‚    â”‚ userId      â”‚â—„â”€â”€â”€â”˜  â”‚ name        â”‚
â”‚ unionid     â”‚  â”‚    â”‚ styleId     â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ code        â”‚
â”‚ nickname    â”‚  â””â”€â”€â”€â–ºâ”‚ modelId     â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ type        â”‚
â”‚ avatar      â”‚       â”‚ prompt      â”‚       â”‚ icon        â”‚
â”‚ phone       â”‚       â”‚ imageUrl    â”‚       â”‚ cover       â”‚
â”‚ gender      â”‚       â”‚ status      â”‚       â”‚ parentId    â”‚
â”‚ memberType  â”‚       â”‚ isPublic    â”‚       â”‚ sort        â”‚
â”‚ quota       â”‚       â”‚ viewCount   â”‚       â”‚ status      â”‚
â”‚ status      â”‚       â”‚ createdAt   â”‚       â”‚ createdAt   â”‚
â”‚ createdAt   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AdminUser  â”‚       â”‚    Task     â”‚       â”‚  AuditLog   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          â”‚       â”‚ id          â”‚       â”‚ id          â”‚
â”‚ username    â”‚       â”‚ userId      â”‚       â”‚ adminId     â”‚
â”‚ password    â”‚       â”‚ type        â”‚       â”‚ action      â”‚
â”‚ salt        â”‚       â”‚ status      â”‚       â”‚ module      â”‚
â”‚ role        â”‚       â”‚ params      â”‚       â”‚ targetId    â”‚
â”‚ permissions â”‚       â”‚ result      â”‚       â”‚ oldValue    â”‚
â”‚ status      â”‚       â”‚ retryCount  â”‚       â”‚ newValue    â”‚
â”‚ lastLoginAt â”‚       â”‚ errorMsg    â”‚       â”‚ ip          â”‚
â”‚ createdAt   â”‚       â”‚ createdAt   â”‚       â”‚ createdAt   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ç”¨æˆ·ç›¸å…³ ====================

model User {
  id              Int       @id @default(autoincrement())
  openid          String    @unique @db.VarChar(64)
  unionid         String?   @db.VarChar(64)
  nickname        String    @db.VarChar(50)
  avatar          String    @db.VarChar(500)
  phone           String?   @db.VarChar(20)
  gender          Int       @default(0) @db.SmallInt  // 0-æœªçŸ¥ 1-ç”· 2-å¥³
  
  // ä¼šå‘˜ä¿¡æ¯
  memberType      String    @default("free") @db.VarChar(20)  // free/basic/pro
  memberExpireAt  DateTime?
  
  // é¢åº¦ä¿¡æ¯
  totalQuota      Int       @default(5)
  usedQuota       Int       @default(0)
  
  // çŠ¶æ€
  status          Int       @default(1) @db.SmallInt  // 0-å°ç¦ 1-æ­£å¸¸
  
  // æ—¶é—´
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // å…³è”
  works           Works[]
  tasks           Task[]
  
  @@index([openid])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@map("users")
}

model AdminUser {
  id              Int       @id @default(autoincrement())
  username        String    @unique @db.VarChar(50)
  password        String    @db.VarChar(100)  // bcrypt å“ˆå¸Œ
  salt            String    @db.VarChar(32)
  realName        String?   @db.VarChar(50)
  role            String    @default("admin") @db.VarChar(20)
  permissions     String[]  @default([])
  
  status          Int       @default(1) @db.SmallInt
  lastLoginAt     DateTime?
  lastLoginIp     String?   @db.VarChar(50)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  auditLogs       AuditLog[]
  
  @@index([username])
  @@map("admin_users")
}

// ==================== åˆ†ç±»ç›¸å…³ ====================

model Category {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(50)
  code            String    @unique @db.VarChar(50)
  type            String    @db.VarChar(20)  // style/model
  icon            String?   @db.VarChar(200)
  cover           String?   @db.VarChar(500)
  description     String?   @db.VarChar(200)
  
  // å±‚çº§
  parentId        Int?
  parent          Category? @relation("CategoryTree", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryTree")
  
  // æ’åºä¸çŠ¶æ€
  sort            Int       @default(0)
  status          Int       @default(1) @db.SmallInt
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // å…³è”
  worksAsStyle    Works[]   @relation("WorkStyle")
  worksAsModel    Works[]   @relation("WorkModel")
  
  @@index([type])
  @@index([status])
  @@index([sort])
  @@map("categories")
}

// ==================== ä½œå“ç›¸å…³ ====================

model Works {
  id              Int       @id @default(autoincrement())
  
  // æ‰€å±ç”¨æˆ·
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  
  // ç”Ÿæˆä¿¡æ¯
  prompt          String    @db.Text
  negativePrompt  String?   @db.Text
  
  // åˆ†ç±»å…³è”
  styleId         Int
  style           Category  @relation("WorkStyle", fields: [styleId], references: [id])
  modelId         Int
  model           Category  @relation("WorkModel", fields: [modelId], references: [id])
  
  // å›¾ç‰‡ä¿¡æ¯
  imageUrl        String    @db.VarChar(500)
  thumbnailUrl    String    @db.VarChar(500)
  width           Int
  height          Int
  fileSize        Int?      // æ–‡ä»¶å¤§å°(KB)
  
  // ç”Ÿæˆå‚æ•°ï¼ˆJSONï¼‰
  params          Json?
  
  // å®¡æ ¸çŠ¶æ€
  status          String    @default("pending") @db.VarChar(20)  // pending/approved/rejected
  auditReason     String?   @db.VarChar(500)
  auditedAt       DateTime?
  auditedBy       Int?
  
  // å…¬å¼€ä¸ç»Ÿè®¡
  isPublic        Boolean   @default(false)
  viewCount       Int       @default(0)
  downloadCount   Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([styleId])
  @@index([status])
  @@index([isPublic])
  @@index([createdAt])
  @@map("works")
}

// ==================== ä»»åŠ¡ç›¸å…³ ====================

model Task {
  id              Int       @id @default(autoincrement())
  taskId          String    @unique @db.VarChar(36)  // UUID
  
  // æ‰€å±ç”¨æˆ·
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  
  // ä»»åŠ¡ç±»å‹
  type            String    @db.VarChar(20)  // text2img/img2img/text
  
  // ä»»åŠ¡çŠ¶æ€
  status          String    @default("pending") @db.VarChar(20)
  // pending -> processing -> completed/failed
  
  // ä»»åŠ¡å‚æ•°ï¼ˆJSONï¼‰
  params          Json
  
  // ä»»åŠ¡ç»“æœ
  result          Json?
  worksId         Int?      // ç”Ÿæˆçš„ä½œå“ID
  
  // é‡è¯•ä¿¡æ¯
  retryCount      Int       @default(0)
  maxRetry        Int       @default(3)
  errorMsg        String?   @db.Text
  
  // æ—¶é—´
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([taskId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("tasks")
}

// ==================== å®¡è®¡æ—¥å¿— ====================

model AuditLog {
  id              Int       @id @default(autoincrement())
  
  // æ“ä½œè€…
  adminId         Int
  admin           AdminUser @relation(fields: [adminId], references: [id])
  
  // æ“ä½œä¿¡æ¯
  action          String    @db.VarChar(50)  // create/update/delete/audit/ban
  module          String    @db.VarChar(50)  // user/works/category
  targetId        Int?
  targetType      String?   @db.VarChar(50)
  
  // å˜æ›´æ•°æ®
  oldValue        Json?
  newValue        Json?
  
  // è¯·æ±‚ä¿¡æ¯
  ip              String    @db.VarChar(50)
  userAgent       String?   @db.VarChar(500)
  
  createdAt       DateTime  @default(now())
  
  @@index([adminId])
  @@index([action])
  @@index([module])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== ç³»ç»Ÿé…ç½® ====================

model SystemConfig {
  id              Int       @id @default(autoincrement())
  key             String    @unique @db.VarChar(100)
  value           String    @db.Text
  description     String?   @db.VarChar(200)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("system_configs")
}
```

### 4.3 æ•°æ®å®Œæ•´æ€§çº¦æŸ

```typescript
// Zod Schema ç”¨äºæ•°æ®éªŒè¯

import { z } from 'zod';

// ç”¨æˆ·æ•°æ®å®Œæ•´æ€§éªŒè¯
export const UserIntegritySchema = z.object({
  id: z.number().int().positive(),
  openid: z.string().min(1).max(64),
  nickname: z.string().min(1).max(50),
  totalQuota: z.number().int().min(0),
  usedQuota: z.number().int().min(0),
  // ç¡®ä¿ usedQuota <= totalQuota
}).refine(data => data.usedQuota <= data.totalQuota, {
  message: 'å·²ç”¨é¢åº¦ä¸èƒ½è¶…è¿‡æ€»é¢åº¦',
  path: ['usedQuota'],
});

// ä½œå“æ•°æ®å®Œæ•´æ€§éªŒè¯
export const WorksIntegritySchema = z.object({
  id: z.number().int().positive(),
  userId: z.number().int().positive(),
  styleId: z.number().int().positive(),
  modelId: z.number().int().positive(),
  imageUrl: z.string().url(),
  width: z.number().int().positive().max(4096),
  height: z.number().int().positive().max(4096),
  viewCount: z.number().int().min(0),
  downloadCount: z.number().int().min(0),
});
```

---

## 5. API æ¥å£è®¾è®¡

### 5.1 ç»Ÿä¸€å“åº”æ ¼å¼

```typescript
import { z } from 'zod';

// ç»Ÿä¸€å“åº” Schema
export const ApiResponseSchema = <T extends z.ZodType>(dataSchema: T) =>
  z.object({
    code: z.number(),           // 0-æˆåŠŸï¼Œå…¶ä»–-å¤±è´¥
    message: z.string(),
    data: dataSchema.optional(),
    timestamp: z.number(),
  });

// åˆ†é¡µå“åº” Schema
export const PaginatedResponseSchema = <T extends z.ZodType>(itemSchema: T) =>
  z.object({
    list: z.array(itemSchema),
    total: z.number().int().min(0),
    page: z.number().int().min(1),
    pageSize: z.number().int().min(1).max(100),
    totalPages: z.number().int().min(0),
  });

// é”™è¯¯ç å®šä¹‰
export const ErrorCodes = {
  SUCCESS: 0,
  
  // é€šç”¨é”™è¯¯ 1xxx
  UNKNOWN_ERROR: 1000,
  VALIDATION_ERROR: 1001,
  NOT_FOUND: 1002,
  FORBIDDEN: 1003,
  
  // è®¤è¯é”™è¯¯ 2xxx
  UNAUTHORIZED: 2000,
  TOKEN_EXPIRED: 2001,
  TOKEN_INVALID: 2002,
  LOGIN_FAILED: 2003,
  
  // ä¸šåŠ¡é”™è¯¯ 3xxx
  QUOTA_EXCEEDED: 3001,
  TASK_FAILED: 3002,
  USER_BANNED: 3003,
  
  // ç³»ç»Ÿé”™è¯¯ 5xxx
  INTERNAL_ERROR: 5000,
  SERVICE_UNAVAILABLE: 5001,
} as const;
```

### 5.2 Zod DTO å®šä¹‰

```typescript
// src/modules/auth/schemas/auth.schema.ts
import { z } from 'zod';

// å¾®ä¿¡ç™»å½•
export const WechatLoginSchema = z.object({
  code: z.string().min(1, 'code ä¸èƒ½ä¸ºç©º'),
  encryptedData: z.string().optional(),
  iv: z.string().optional(),
});
export type WechatLoginInput = z.infer<typeof WechatLoginSchema>;

// åˆ·æ–° Token
export const RefreshTokenSchema = z.object({
  refreshToken: z.string().min(1, 'refreshToken ä¸èƒ½ä¸ºç©º'),
});
export type RefreshTokenInput = z.infer<typeof RefreshTokenSchema>;

// ç™»å½•å“åº”
export const LoginResponseSchema = z.object({
  accessToken: z.string(),
  refreshToken: z.string(),
  expiresIn: z.number(),
  user: z.object({
    id: z.number(),
    nickname: z.string(),
    avatar: z.string(),
    memberType: z.string(),
    remainQuota: z.number(),
  }),
});
```

```typescript
// src/modules/works/schemas/works.schema.ts
import { z } from 'zod';

// åˆ›å»ºä½œå“ï¼ˆç”Ÿæˆä»»åŠ¡ï¼‰
export const CreateWorksSchema = z.object({
  prompt: z.string().min(1, 'æç¤ºè¯ä¸èƒ½ä¸ºç©º').max(2000, 'æç¤ºè¯æœ€å¤š2000å­—'),
  negativePrompt: z.string().max(1000).optional(),
  styleId: z.number().int().positive('è¯·é€‰æ‹©é£æ ¼'),
  modelId: z.number().int().positive('è¯·é€‰æ‹©æ¨¡å‹'),
  params: z.object({
    width: z.number().int().min(256).max(2048).default(1024),
    height: z.number().int().min(256).max(2048).default(1024),
    steps: z.number().int().min(1).max(100).default(30),
    guidance: z.number().min(1).max(30).default(7.5),
    seed: z.number().int().optional(),
  }).optional(),
});
export type CreateWorksInput = z.infer<typeof CreateWorksSchema>;

// æŸ¥è¯¢ä½œå“åˆ—è¡¨
export const QueryWorksSchema = z.object({
  page: z.coerce.number().int().min(1).default(1),
  pageSize: z.coerce.number().int().min(1).max(100).default(20),
  styleId: z.coerce.number().int().positive().optional(),
  status: z.enum(['pending', 'approved', 'rejected']).optional(),
  startDate: z.string().datetime().optional(),
  endDate: z.string().datetime().optional(),
  keyword: z.string().max(100).optional(),
});
export type QueryWorksInput = z.infer<typeof QueryWorksSchema>;

// å®¡æ ¸ä½œå“
export const AuditWorksSchema = z.object({
  status: z.enum(['approved', 'rejected']),
  reason: z.string().max(500).optional(),
}).refine(
  data => data.status !== 'rejected' || data.reason,
  { message: 'æ‹’ç»æ—¶å¿…é¡»å¡«å†™åŸå› ', path: ['reason'] }
);
export type AuditWorksInput = z.infer<typeof AuditWorksSchema>;
```

### 5.3 Zod éªŒè¯ç®¡é“

```typescript
// src/common/pipes/zod-validation.pipe.ts
import { PipeTransform, Injectable, BadRequestException } from '@nestjs/common';
import { ZodSchema, ZodError } from 'zod';

@Injectable()
export class ZodValidationPipe implements PipeTransform {
  constructor(private schema: ZodSchema) {}

  transform(value: unknown) {
    try {
      return this.schema.parse(value);
    } catch (error) {
      if (error instanceof ZodError) {
        const messages = error.errors.map(err => ({
          field: err.path.join('.'),
          message: err.message,
        }));
        throw new BadRequestException({
          code: 1001,
          message: 'å‚æ•°éªŒè¯å¤±è´¥',
          errors: messages,
        });
      }
      throw error;
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
@Controller('works')
export class WorksController {
  @Post()
  @UseGuards(JwtAuthGuard)
  async create(
    @Body(new ZodValidationPipe(CreateWorksSchema)) dto: CreateWorksInput,
    @CurrentUser() user: User,
  ) {
    return this.worksService.create(dto, user);
  }
}
```

### 5.4 æ¥å£æ¸…å•

#### å°ç¨‹åºç«¯æ¥å£

| æ¨¡å— | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| **è®¤è¯** | POST | `/api/auth/wechat-login` | å¾®ä¿¡ç™»å½• |
| | POST | `/api/auth/refresh` | åˆ·æ–° Token |
| | GET | `/api/auth/profile` | è·å–ç”¨æˆ·ä¿¡æ¯ |
| **åˆ†ç±»** | GET | `/api/category/styles` | é£æ ¼åˆ—è¡¨ |
| | GET | `/api/category/models` | æ¨¡å‹åˆ—è¡¨ |
| **ä½œå“** | POST | `/api/works` | åˆ›å»ºä½œå“ï¼ˆæäº¤ç”Ÿæˆä»»åŠ¡ï¼‰ |
| | GET | `/api/works` | æˆ‘çš„ä½œå“åˆ—è¡¨ |
| | GET | `/api/works/:id` | ä½œå“è¯¦æƒ… |
| | DELETE | `/api/works/:id` | åˆ é™¤ä½œå“ |
| | GET | `/api/works/public` | å…¬å¼€ä½œå“å¹¿åœº |
| **ä»»åŠ¡** | GET | `/api/task/:taskId` | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ |
| | DELETE | `/api/task/:taskId` | å–æ¶ˆä»»åŠ¡ |

#### ç®¡ç†ç«¯æ¥å£

| æ¨¡å— | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| **è®¤è¯** | POST | `/api/admin/login` | ç®¡ç†å‘˜ç™»å½• |
| | POST | `/api/admin/logout` | é€€å‡ºç™»å½• |
| **é¢æ¿** | GET | `/api/admin/dashboard/overview` | æ¦‚è§ˆæ•°æ® |
| | GET | `/api/admin/dashboard/trend` | è¶‹åŠ¿æ•°æ® |
| **åˆ†ç±»** | GET | `/api/admin/category` | åˆ†ç±»åˆ—è¡¨ |
| | POST | `/api/admin/category` | æ–°å¢åˆ†ç±» |
| | PUT | `/api/admin/category/:id` | ç¼–è¾‘åˆ†ç±» |
| | DELETE | `/api/admin/category/:id` | åˆ é™¤åˆ†ç±» |
| **ä½œå“** | GET | `/api/admin/works` | ä½œå“åˆ—è¡¨ |
| | PUT | `/api/admin/works/:id/audit` | å®¡æ ¸ä½œå“ |
| | DELETE | `/api/admin/works/:id` | åˆ é™¤ä½œå“ |
| **ç”¨æˆ·** | GET | `/api/admin/user` | ç”¨æˆ·åˆ—è¡¨ |
| | PUT | `/api/admin/user/:id/status` | å°ç¦/è§£å° |
| | PUT | `/api/admin/user/:id/quota` | è°ƒæ•´é¢åº¦ |
| **æ—¥å¿—** | GET | `/api/admin/audit-log` | æ“ä½œæ—¥å¿— |

---

## 6. å®‰å…¨è®¾è®¡

### 6.1 è®¤è¯å®‰å…¨

#### JWT Token è®¾è®¡
```typescript
// src/modules/auth/auth.service.ts
import { z } from 'zod';

// Token Payload Schema
export const TokenPayloadSchema = z.object({
  sub: z.number(),              // ç”¨æˆ·ID
  type: z.enum(['access', 'refresh']),
  role: z.string().optional(),  // ç®¡ç†å‘˜è§’è‰²
  iat: z.number(),              // ç­¾å‘æ—¶é—´
  exp: z.number(),              // è¿‡æœŸæ—¶é—´
});

@Injectable()
export class AuthService {
  // Token é…ç½®
  private readonly ACCESS_TOKEN_EXPIRES = '15m';   // è®¿é—®ä»¤ç‰Œ15åˆ†é’Ÿ
  private readonly REFRESH_TOKEN_EXPIRES = '7d';   // åˆ·æ–°ä»¤ç‰Œ7å¤©
  
  // ç”Ÿæˆ Token å¯¹
  async generateTokens(userId: number, role?: string) {
    const [accessToken, refreshToken] = await Promise.all([
      this.jwtService.signAsync(
        { sub: userId, type: 'access', role },
        { expiresIn: this.ACCESS_TOKEN_EXPIRES }
      ),
      this.jwtService.signAsync(
        { sub: userId, type: 'refresh' },
        { expiresIn: this.REFRESH_TOKEN_EXPIRES }
      ),
    ]);
    
    // å­˜å‚¨ refreshToken åˆ° Redisï¼ˆæ”¯æŒä¸»åŠ¨å¤±æ•ˆï¼‰
    await this.redis.set(
      `refresh_token:${userId}`,
      refreshToken,
      'EX',
      7 * 24 * 60 * 60
    );
    
    return { accessToken, refreshToken };
  }
  
  // Token åˆ·æ–°
  async refreshTokens(refreshToken: string) {
    const payload = await this.jwtService.verifyAsync(refreshToken);
    
    // éªŒè¯ Token ç±»å‹
    if (payload.type !== 'refresh') {
      throw new UnauthorizedException('æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ');
    }
    
    // éªŒè¯ Redis ä¸­çš„ Token
    const storedToken = await this.redis.get(`refresh_token:${payload.sub}`);
    if (storedToken !== refreshToken) {
      throw new UnauthorizedException('åˆ·æ–°ä»¤ç‰Œå·²å¤±æ•ˆ');
    }
    
    return this.generateTokens(payload.sub, payload.role);
  }
  
  // ç™»å‡ºï¼ˆä½¿ Token å¤±æ•ˆï¼‰
  async logout(userId: number) {
    await this.redis.del(`refresh_token:${userId}`);
  }
}
```

#### å¯†ç å®‰å…¨
```typescript
// src/utils/crypto.util.ts
import * as bcrypt from 'bcrypt';
import * as crypto from 'crypto';

const SALT_ROUNDS = 12;

// å¯†ç å“ˆå¸Œ
export async function hashPassword(password: string): Promise<{ hash: string; salt: string }> {
  const salt = crypto.randomBytes(16).toString('hex');
  const saltedPassword = password + salt;
  const hash = await bcrypt.hash(saltedPassword, SALT_ROUNDS);
  return { hash, salt };
}

// å¯†ç éªŒè¯
export async function verifyPassword(
  password: string,
  hash: string,
  salt: string
): Promise<boolean> {
  const saltedPassword = password + salt;
  return bcrypt.compare(saltedPassword, hash);
}

// å¯†ç å¼ºåº¦éªŒè¯ Schema
export const PasswordSchema = z.string()
  .min(8, 'å¯†ç è‡³å°‘8ä½')
  .max(32, 'å¯†ç æœ€å¤š32ä½')
  .regex(/[A-Z]/, 'éœ€åŒ…å«å¤§å†™å­—æ¯')
  .regex(/[a-z]/, 'éœ€åŒ…å«å°å†™å­—æ¯')
  .regex(/[0-9]/, 'éœ€åŒ…å«æ•°å­—')
  .regex(/[^A-Za-z0-9]/, 'éœ€åŒ…å«ç‰¹æ®Šå­—ç¬¦');
```

### 6.2 è¯·æ±‚å®‰å…¨

#### è¯·æ±‚é¢‘ç‡é™åˆ¶
```typescript
// src/common/guards/throttle.guard.ts
import { ThrottlerGuard, ThrottlerModule } from '@nestjs/throttler';

// å…¨å±€é…ç½®
@Module({
  imports: [
    ThrottlerModule.forRoot([
      {
        name: 'short',
        ttl: 1000,      // 1ç§’
        limit: 10,      // æœ€å¤š10æ¬¡
      },
      {
        name: 'medium',
        ttl: 10000,     // 10ç§’
        limit: 50,      // æœ€å¤š50æ¬¡
      },
      {
        name: 'long',
        ttl: 60000,     // 1åˆ†é’Ÿ
        limit: 100,     // æœ€å¤š100æ¬¡
      },
    ]),
  ],
})
export class AppModule {}

// è‡ªå®šä¹‰é™æµ - ç™»å½•æ¥å£
@Controller('auth')
export class AuthController {
  @Post('login')
  @Throttle({ short: { limit: 5, ttl: 60000 } })  // 1åˆ†é’Ÿæœ€å¤š5æ¬¡
  async login(@Body() dto: LoginDto) {
    // ...
  }
}

// è‡ªå®šä¹‰é™æµ - ç”Ÿæˆæ¥å£
@Controller('works')
export class WorksController {
  @Post()
  @Throttle({ short: { limit: 3, ttl: 60000 } })  // 1åˆ†é’Ÿæœ€å¤š3æ¬¡
  async create(@Body() dto: CreateWorksDto) {
    // ...
  }
}
```

#### IP é»‘åå•
```typescript
// src/common/guards/ip-blacklist.guard.ts
@Injectable()
export class IpBlacklistGuard implements CanActivate {
  constructor(private readonly redis: RedisService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const ip = this.getClientIp(request);
    
    // æ£€æŸ¥ IP æ˜¯å¦åœ¨é»‘åå•
    const isBlocked = await this.redis.sismember('ip:blacklist', ip);
    if (isBlocked) {
      throw new ForbiddenException('IP å·²è¢«å°ç¦');
    }
    
    return true;
  }
  
  private getClientIp(request: Request): string {
    const forwarded = request.headers['x-forwarded-for'];
    if (forwarded) {
      return (typeof forwarded === 'string' ? forwarded : forwarded[0]).split(',')[0].trim();
    }
    return request.socket.remoteAddress || '';
  }
}
```

### 6.3 æ•°æ®å®‰å…¨

#### SQL æ³¨å…¥é˜²æŠ¤
```typescript
// Prisma è‡ªåŠ¨é˜²æŠ¤ SQL æ³¨å…¥
// âœ… å®‰å…¨ï¼šä½¿ç”¨ Prisma å‚æ•°åŒ–æŸ¥è¯¢
const users = await prisma.user.findMany({
  where: {
    nickname: { contains: keyword },
  },
});

// âŒ å±é™©ï¼šåŸå§‹ SQL æ‹¼æ¥
const users = await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE nickname LIKE '%${keyword}%'`
);

// âœ… å®‰å…¨ï¼šåŸå§‹ SQL å‚æ•°åŒ–
const users = await prisma.$queryRaw`
  SELECT * FROM users WHERE nickname LIKE ${`%${keyword}%`}
`;
```

#### æ•æ„Ÿæ•°æ®è„±æ•
```typescript
// src/utils/mask.util.ts

// æ‰‹æœºå·è„±æ•
export function maskPhone(phone: string): string {
  if (!phone || phone.length !== 11) return phone;
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
}

// OpenID è„±æ•ï¼ˆæ—¥å¿—ä½¿ç”¨ï¼‰
export function maskOpenId(openId: string): string {
  if (!openId || openId.length < 10) return '***';
  return openId.slice(0, 6) + '****' + openId.slice(-4);
}

// å“åº”æ•°æ®è‡ªåŠ¨è„±æ•
export function sanitizeResponse<T>(data: T, sensitiveFields: string[] = []): T {
  const defaultSensitive = ['openid', 'unionid', 'password', 'salt', 'sessionKey'];
  const allSensitive = [...defaultSensitive, ...sensitiveFields];
  
  if (Array.isArray(data)) {
    return data.map(item => sanitizeResponse(item, sensitiveFields)) as T;
  }
  
  if (data && typeof data === 'object') {
    const result = { ...data };
    for (const key of allSensitive) {
      if (key in result) {
        delete (result as any)[key];
      }
    }
    // æ‰‹æœºå·è„±æ•æ˜¾ç¤º
    if ('phone' in result && result.phone) {
      (result as any).phone = maskPhone((result as any).phone);
    }
    return result;
  }
  
  return data;
}
```

#### æ–‡ä»¶ä¸Šä¼ å®‰å…¨
```typescript
// src/modules/storage/storage.service.ts
import { z } from 'zod';

// æ–‡ä»¶ä¸Šä¼ éªŒè¯ Schema
export const FileUploadSchema = z.object({
  mimetype: z.enum([
    'image/jpeg',
    'image/png',
    'image/webp',
    'image/gif',
  ], { errorMap: () => ({ message: 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼' }) }),
  size: z.number().max(10 * 1024 * 1024, 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB'),
});

@Injectable()
export class StorageService {
  // å…è®¸çš„æ–‡ä»¶ç±»å‹
  private readonly ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
  private readonly MAX_SIZE = 10 * 1024 * 1024; // 10MB
  
  async uploadImage(file: Express.Multer.File, userId: number): Promise<string> {
    // 1. éªŒè¯æ–‡ä»¶ç±»å‹
    if (!this.ALLOWED_TYPES.includes(file.mimetype)) {
      throw new BadRequestException('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
    }
    
    // 2. éªŒè¯æ–‡ä»¶å¤§å°
    if (file.size > this.MAX_SIZE) {
      throw new BadRequestException('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶');
    }
    
    // 3. éªŒè¯æ–‡ä»¶å†…å®¹ï¼ˆé­”æ•°æ£€æµ‹ï¼‰
    const isValid = await this.validateFileContent(file.buffer);
    if (!isValid) {
      throw new BadRequestException('æ–‡ä»¶å†…å®¹æ— æ•ˆ');
    }
    
    // 4. ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
    const ext = this.getExtension(file.mimetype);
    const fileName = `${userId}/${Date.now()}_${crypto.randomUUID()}${ext}`;
    
    // 5. ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
    return this.uploadToStorage(fileName, file.buffer, file.mimetype);
  }
  
  // éªŒè¯æ–‡ä»¶é­”æ•°
  private async validateFileContent(buffer: Buffer): Promise<boolean> {
    const magicNumbers = {
      jpeg: [0xFF, 0xD8, 0xFF],
      png: [0x89, 0x50, 0x4E, 0x47],
      webp: [0x52, 0x49, 0x46, 0x46],
    };
    
    for (const [type, magic] of Object.entries(magicNumbers)) {
      if (magic.every((byte, i) => buffer[i] === byte)) {
        return true;
      }
    }
    return false;
  }
}
```

### 6.4 æ—¥å¿—å®¡è®¡

```typescript
// src/common/interceptors/audit.interceptor.ts
@Injectable()
export class AuditInterceptor implements NestInterceptor {
  constructor(
    private readonly prisma: PrismaService,
    private readonly logger: LoggerService,
  ) {}

  async intercept(context: ExecutionContext, next: CallHandler): Promise<Observable<any>> {
    const request = context.switchToHttp().getRequest();
    const { method, url, body, user, ip, headers } = request;
    
    // éœ€è¦å®¡è®¡çš„æ“ä½œ
    const auditActions = ['POST', 'PUT', 'PATCH', 'DELETE'];
    
    if (!auditActions.includes(method)) {
      return next.handle();
    }
    
    const startTime = Date.now();
    
    return next.handle().pipe(
      tap(async (response) => {
        // è®°å½•å®¡è®¡æ—¥å¿—
        if (user?.isAdmin) {
          await this.prisma.auditLog.create({
            data: {
              adminId: user.id,
              action: this.getAction(method),
              module: this.getModule(url),
              targetId: body?.id || response?.data?.id,
              targetType: this.getTargetType(url),
              newValue: body,
              ip: ip,
              userAgent: headers['user-agent'],
            },
          });
        }
        
        // è®°å½•è¯·æ±‚æ—¥å¿—
        this.logger.log({
          type: 'request',
          method,
          url,
          userId: user?.id,
          duration: Date.now() - startTime,
          status: 'success',
        });
      }),
      catchError((error) => {
        // è®°å½•é”™è¯¯æ—¥å¿—
        this.logger.error({
          type: 'request',
          method,
          url,
          userId: user?.id,
          duration: Date.now() - startTime,
          status: 'error',
          error: error.message,
        });
        throw error;
      }),
    );
  }
}
```

### 6.5 HTTP å®‰å…¨å¤´

```typescript
// src/main.ts
import helmet from 'helmet';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // Helmet å®‰å…¨å¤´é…ç½®
  app.use(helmet({
    // å†…å®¹å®‰å…¨ç­–ç•¥
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        imgSrc: ["'self'", 'data:', 'https:'],
        scriptSrc: ["'self'"],
      },
    },
    // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    frameguard: { action: 'deny' },
    // ç¦ç”¨ MIME ç±»å‹å—…æ¢
    noSniff: true,
    // XSS è¿‡æ»¤
    xssFilter: true,
    // éšè— X-Powered-By
    hidePoweredBy: true,
  }));
  
  // CORS é…ç½®
  app.enableCors({
    origin: process.env.CORS_ORIGINS?.split(',') || ['http://localhost:3000'],
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
    credentials: true,
  });
  
  await app.listen(process.env.PORT || 3000);
}
```

### 6.6 å®‰å…¨æ£€æŸ¥æ¸…å•

| ç±»åˆ« | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|------|--------|------|
| **è®¤è¯** | JWT çŸ­æœŸè¿‡æœŸ + Refresh Token | â˜ |
| | Token å­˜å‚¨åœ¨ Redis æ”¯æŒä¸»åŠ¨å¤±æ•ˆ | â˜ |
| | å¯†ç  bcrypt + salt å“ˆå¸Œ | â˜ |
| | ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ | â˜ |
| **æˆæƒ** | æ¥å£æƒé™æ ¡éªŒ | â˜ |
| | æ•°æ®æƒé™éš”ç¦»ï¼ˆç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ï¼‰ | â˜ |
| | ç®¡ç†å‘˜è§’è‰²æƒé™æ§åˆ¶ | â˜ |
| **è¯·æ±‚** | è¯·æ±‚é¢‘ç‡é™åˆ¶ | â˜ |
| | IP é»‘åå• | â˜ |
| | è¯·æ±‚å‚æ•°éªŒè¯ï¼ˆZodï¼‰ | â˜ |
| **æ•°æ®** | SQL æ³¨å…¥é˜²æŠ¤ï¼ˆPrismaï¼‰ | â˜ |
| | XSS é˜²æŠ¤ï¼ˆè¾“å…¥è¿‡æ»¤ï¼‰ | â˜ |
| | æ•æ„Ÿæ•°æ®è„±æ• | â˜ |
| **ä¼ è¾“** | å…¨ç«™ HTTPS | â˜ |
| | Helmet å®‰å…¨å¤´ | â˜ |
| | CORS é…ç½® | â˜ |
| **æ–‡ä»¶** | æ–‡ä»¶ç±»å‹ç™½åå• | â˜ |
| | æ–‡ä»¶å¤§å°é™åˆ¶ | â˜ |
| | æ–‡ä»¶å†…å®¹éªŒè¯ | â˜ |
| **æ—¥å¿—** | è¯·æ±‚æ—¥å¿—è®°å½• | â˜ |
| | æ“ä½œå®¡è®¡æ—¥å¿— | â˜ |
| | æ•æ„Ÿä¿¡æ¯ä¸è®°å½• | â˜ |

---

## 7. æ•°æ®å‡†ç¡®æ€§ä¿éšœ

### 7.1 æ•°æ®éªŒè¯å±‚

```typescript
// ä¸‰å±‚éªŒè¯ç­–ç•¥

// 1. æ¥å£å±‚ - Zod Schema éªŒè¯
@Post()
async create(
  @Body(new ZodValidationPipe(CreateWorksSchema)) dto: CreateWorksInput,
) {
  // dto å·²ç»è¿‡éªŒè¯
}

// 2. æœåŠ¡å±‚ - ä¸šåŠ¡é€»è¾‘éªŒè¯
@Injectable()
export class WorksService {
  async create(dto: CreateWorksInput, user: User) {
    // éªŒè¯ç”¨æˆ·é¢åº¦
    if (user.usedQuota >= user.totalQuota) {
      throw new BadRequestException('ç”Ÿæˆé¢åº¦ä¸è¶³');
    }
    
    // éªŒè¯åˆ†ç±»å­˜åœ¨ä¸”å¯ç”¨
    const style = await this.prisma.category.findUnique({
      where: { id: dto.styleId, status: 1 },
    });
    if (!style) {
      throw new BadRequestException('é£æ ¼ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨');
    }
    
    // éªŒè¯æ¨¡å‹å­˜åœ¨ä¸”å¯ç”¨
    const model = await this.prisma.category.findUnique({
      where: { id: dto.modelId, status: 1 },
    });
    if (!model) {
      throw new BadRequestException('æ¨¡å‹ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨');
    }
    
    // åˆ›å»ºä»»åŠ¡...
  }
}

// 3. æ•°æ®åº“å±‚ - çº¦æŸéªŒè¯
// Prisma schema ä¸­çš„çº¦æŸï¼š@unique, @default, å…³ç³»çº¦æŸç­‰
```

### 7.2 äº‹åŠ¡ä¸ä¸€è‡´æ€§

```typescript
// ä½¿ç”¨ Prisma äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
@Injectable()
export class WorksService {
  async create(dto: CreateWorksInput, user: User) {
    return this.prisma.$transaction(async (tx) => {
      // 1. æ‰£å‡ç”¨æˆ·é¢åº¦
      const updatedUser = await tx.user.update({
        where: { id: user.id },
        data: { usedQuota: { increment: 1 } },
      });
      
      // 2. éªŒè¯é¢åº¦ï¼ˆä¹è§‚é”æ£€æŸ¥ï¼‰
      if (updatedUser.usedQuota > updatedUser.totalQuota) {
        throw new BadRequestException('é¢åº¦ä¸è¶³');
      }
      
      // 3. åˆ›å»ºä»»åŠ¡
      const task = await tx.task.create({
        data: {
          taskId: crypto.randomUUID(),
          userId: user.id,
          type: 'text2img',
          status: 'pending',
          params: dto,
        },
      });
      
      return task;
    }, {
      isolationLevel: 'Serializable',  // æœ€é«˜éš”ç¦»çº§åˆ«
      timeout: 10000,  // 10ç§’è¶…æ—¶
    });
  }
}
```

### 7.3 å¹‚ç­‰æ€§è®¾è®¡

```typescript
// ä½¿ç”¨å¹‚ç­‰é”®é˜²æ­¢é‡å¤æäº¤
@Injectable()
export class IdempotencyService {
  constructor(private readonly redis: RedisService) {}
  
  async checkAndSet(key: string, ttl: number = 300): Promise<boolean> {
    // ä½¿ç”¨ Redis SETNX å®ç°å¹‚ç­‰æ£€æŸ¥
    const result = await this.redis.set(
      `idempotency:${key}`,
      '1',
      'EX',
      ttl,
      'NX'
    );
    return result === 'OK';
  }
}

// æ§åˆ¶å™¨ä¸­ä½¿ç”¨
@Controller('works')
export class WorksController {
  @Post()
  async create(
    @Body() dto: CreateWorksInput,
    @Headers('X-Idempotency-Key') idempotencyKey: string,
    @CurrentUser() user: User,
  ) {
    if (!idempotencyKey) {
      throw new BadRequestException('ç¼ºå°‘å¹‚ç­‰é”®');
    }
    
    // æ£€æŸ¥æ˜¯å¦é‡å¤è¯·æ±‚
    const isNew = await this.idempotencyService.checkAndSet(
      `${user.id}:${idempotencyKey}`
    );
    if (!isNew) {
      throw new ConflictException('è¯·å‹¿é‡å¤æäº¤');
    }
    
    return this.worksService.create(dto, user);
  }
}
```

### 7.4 æ•°æ®æ ¡éªŒ Schema

```typescript
// src/modules/works/schemas/works-validation.schema.ts
import { z } from 'zod';

// æç¤ºè¯å®‰å…¨éªŒè¯
export const PromptSafetySchema = z.string()
  .min(1, 'æç¤ºè¯ä¸èƒ½ä¸ºç©º')
  .max(2000, 'æç¤ºè¯è¿‡é•¿')
  .refine(
    (val) => !containsSensitiveWords(val),
    { message: 'æç¤ºè¯åŒ…å«æ•æ„Ÿå†…å®¹' }
  );

// å›¾ç‰‡å°ºå¯¸éªŒè¯
export const ImageSizeSchema = z.object({
  width: z.number().int().positive(),
  height: z.number().int().positive(),
}).refine(
  (data) => data.width * data.height <= 4096 * 4096,
  { message: 'å›¾ç‰‡å°ºå¯¸è¿‡å¤§' }
).refine(
  (data) => data.width / data.height >= 0.25 && data.width / data.height <= 4,
  { message: 'å›¾ç‰‡æ¯”ä¾‹ä¸åˆç†' }
);

// ç”Ÿæˆå‚æ•°éªŒè¯
export const GenerateParamsSchema = z.object({
  steps: z.number().int().min(10).max(100),
  guidance: z.number().min(1).max(30),
  seed: z.number().int().min(0).max(4294967295).optional(),
}).strict();  // ä¸å…è®¸é¢å¤–å­—æ®µ
```

### 7.5 æ•°æ®ç›‘æ§ä¸å‘Šè­¦

```typescript
// src/shared/monitoring/data-monitor.service.ts
@Injectable()
export class DataMonitorService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly logger: LoggerService,
  ) {}

  // å®šæ—¶æ£€æŸ¥æ•°æ®å¼‚å¸¸
  @Cron('0 */10 * * * *')  // æ¯10åˆ†é’Ÿ
  async checkDataAnomalies() {
    // æ£€æŸ¥é¢åº¦å¼‚å¸¸ï¼ˆå·²ç”¨ > æ€»é¢åº¦ï¼‰
    const quotaAnomalies = await this.prisma.user.findMany({
      where: {
        usedQuota: { gt: this.prisma.user.fields.totalQuota },
      },
    });
    
    if (quotaAnomalies.length > 0) {
      this.logger.error('æ•°æ®å¼‚å¸¸ï¼šå‘ç°é¢åº¦è¶…æ”¯ç”¨æˆ·', {
        count: quotaAnomalies.length,
        userIds: quotaAnomalies.map(u => u.id),
      });
      // å‘é€å‘Šè­¦
      await this.sendAlert('QUOTA_ANOMALY', quotaAnomalies);
    }
    
    // æ£€æŸ¥å­¤ç«‹ä»»åŠ¡ï¼ˆè¶…è¿‡1å°æ—¶ä»åœ¨ processingï¼‰
    const stuckTasks = await this.prisma.task.findMany({
      where: {
        status: 'processing',
        updatedAt: { lt: new Date(Date.now() - 60 * 60 * 1000) },
      },
    });
    
    if (stuckTasks.length > 0) {
      this.logger.warn('æ•°æ®å¼‚å¸¸ï¼šå‘ç°å¡ä½çš„ä»»åŠ¡', {
        count: stuckTasks.length,
        taskIds: stuckTasks.map(t => t.taskId),
      });
    }
  }
}
```

---

## 8. ä»»åŠ¡é˜Ÿåˆ—ä¸è°ƒåº¦

### 8.1 BullMQ é…ç½®

```typescript
// src/modules/task/task.module.ts
import { BullModule } from '@nestjs/bull';

@Module({
  imports: [
    BullModule.registerQueue({
      name: 'image-generation',
      defaultJobOptions: {
        attempts: 3,                    // æœ€å¤šé‡è¯•3æ¬¡
        backoff: {
          type: 'exponential',
          delay: 5000,                  // åˆå§‹å»¶è¿Ÿ5ç§’
        },
        removeOnComplete: 100,          // ä¿ç•™æœ€è¿‘100ä¸ªå®Œæˆä»»åŠ¡
        removeOnFail: 1000,             // ä¿ç•™æœ€è¿‘1000ä¸ªå¤±è´¥ä»»åŠ¡
      },
    }),
  ],
})
export class TaskModule {}
```

### 8.2 ä»»åŠ¡å¤„ç†å™¨

```typescript
// src/modules/task/task.processor.ts
import { Processor, Process, OnQueueFailed, OnQueueCompleted } from '@nestjs/bull';
import { z } from 'zod';

// ä»»åŠ¡æ•°æ® Schema
export const GenerationJobDataSchema = z.object({
  taskId: z.string().uuid(),
  userId: z.number(),
  prompt: z.string(),
  negativePrompt: z.string().optional(),
  styleId: z.number(),
  modelId: z.number(),
  params: z.object({
    width: z.number(),
    height: z.number(),
    steps: z.number(),
    guidance: z.number(),
    seed: z.number().optional(),
  }),
});

@Processor('image-generation')
export class TaskProcessor {
  constructor(
    private readonly prisma: PrismaService,
    private readonly aiService: AIModelService,
    private readonly storageService: StorageService,
    private readonly logger: LoggerService,
  ) {}

  @Process()
  async handleGeneration(job: Job<z.infer<typeof GenerationJobDataSchema>>) {
    const { taskId, userId, prompt, params } = job.data;
    
    this.logger.log(`å¼€å§‹å¤„ç†ä»»åŠ¡: ${taskId}`);
    
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    await this.prisma.task.update({
      where: { taskId },
      data: { status: 'processing', startedAt: new Date() },
    });
    
    try {
      // 1. è°ƒç”¨ AI æ¨¡å‹ç”Ÿæˆå›¾ç‰‡
      const imageBuffer = await this.aiService.generateImage({
        prompt,
        negativePrompt: job.data.negativePrompt,
        ...params,
      });
      
      // 2. ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
      const imageUrl = await this.storageService.upload(imageBuffer, userId);
      const thumbnailUrl = await this.storageService.uploadThumbnail(imageBuffer, userId);
      
      // 3. åˆ›å»ºä½œå“è®°å½•
      const works = await this.prisma.$transaction(async (tx) => {
        // åˆ›å»ºä½œå“
        const work = await tx.works.create({
          data: {
            userId,
            prompt,
            negativePrompt: job.data.negativePrompt,
            styleId: job.data.styleId,
            modelId: job.data.modelId,
            imageUrl,
            thumbnailUrl,
            width: params.width,
            height: params.height,
            params,
            status: 'approved',  // è‡ªåŠ¨å®¡æ ¸é€šè¿‡ï¼ˆå¯é…ç½®ï¼‰
          },
        });
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        await tx.task.update({
          where: { taskId },
          data: {
            status: 'completed',
            result: { worksId: work.id, imageUrl },
            worksId: work.id,
            completedAt: new Date(),
          },
        });
        
        return work;
      });
      
      this.logger.log(`ä»»åŠ¡å®Œæˆ: ${taskId}, ä½œå“ID: ${works.id}`);
      
      return { worksId: works.id, imageUrl };
      
    } catch (error) {
      this.logger.error(`ä»»åŠ¡å¤±è´¥: ${taskId}`, error);
      
      // æ›´æ–°ä»»åŠ¡å¤±è´¥çŠ¶æ€
      await this.prisma.task.update({
        where: { taskId },
        data: {
          status: 'failed',
          errorMsg: error.message,
          retryCount: { increment: 1 },
        },
      });
      
      throw error;  // è§¦å‘é‡è¯•
    }
  }

  @OnQueueFailed()
  async onFailed(job: Job, error: Error) {
    this.logger.error(`ä»»åŠ¡æœ€ç»ˆå¤±è´¥: ${job.data.taskId}`, {
      error: error.message,
      attempts: job.attemptsMade,
    });
    
    // ä»»åŠ¡æœ€ç»ˆå¤±è´¥ï¼Œæ¢å¤ç”¨æˆ·é¢åº¦
    if (job.attemptsMade >= job.opts.attempts) {
      await this.prisma.user.update({
        where: { id: job.data.userId },
        data: { usedQuota: { decrement: 1 } },
      });
    }
  }
}
```

### 8.3 ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢

```typescript
// src/modules/task/task.service.ts
@Injectable()
export class TaskService {
  // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
  async getTaskStatus(taskId: string, userId: number) {
    const task = await this.prisma.task.findUnique({
      where: { taskId },
      include: {
        user: { select: { id: true } },
      },
    });
    
    if (!task) {
      throw new NotFoundException('ä»»åŠ¡ä¸å­˜åœ¨');
    }
    
    // éªŒè¯æƒé™
    if (task.userId !== userId) {
      throw new ForbiddenException('æ— æƒè®¿é—®æ­¤ä»»åŠ¡');
    }
    
    // è·å–é˜Ÿåˆ—ä½ç½®ï¼ˆå¦‚æœæ˜¯ç­‰å¾…ä¸­ï¼‰
    let queuePosition: number | undefined;
    if (task.status === 'pending') {
      const job = await this.queue.getJob(taskId);
      if (job) {
        const waiting = await this.queue.getWaiting();
        queuePosition = waiting.findIndex(j => j.id === taskId) + 1;
      }
    }
    
    return {
      taskId: task.taskId,
      status: task.status,
      queuePosition,
      result: task.result,
      errorMsg: task.errorMsg,
      createdAt: task.createdAt,
      completedAt: task.completedAt,
    };
  }
}
```

---

## 9. éƒ¨ç½²ä¸è¿ç»´

### 9.1 ç¯å¢ƒå˜é‡

```bash
# .env.example

# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000
API_PREFIX=/api

# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@localhost:5432/dbname?schema=public

# Redis
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=your-super-secret-key-at-least-32-characters
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# å¾®ä¿¡å°ç¨‹åº
WECHAT_APPID=wx1234567890
WECHAT_SECRET=your-wechat-secret

# å¯¹è±¡å­˜å‚¨
STORAGE_TYPE=minio  # minio | cos
MINIO_ENDPOINT=localhost
MINIO_PORT=9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=images

# AI æ¨¡å‹æœåŠ¡
AI_SERVICE_URL=http://localhost:8000
AI_SERVICE_KEY=your-ai-service-key

# æ—¥å¿—
LOG_LEVEL=info
LOG_FILE=/var/log/app/server.log

# CORS
CORS_ORIGINS=https://your-domain.com
```

### 9.2 Docker é…ç½®

```dockerfile
# Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma/

RUN npm ci

COPY . .

RUN npm run build
RUN npx prisma generate

FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nestjs

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/prisma ./prisma

USER nestjs

EXPOSE 3000

CMD ["node", "dist/main.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/app
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  worker:
    build: .
    command: ["node", "dist/worker.js"]
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/app
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=app
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  minio_data:
```

### 9.3 å¥åº·æ£€æŸ¥

```typescript
// src/health/health.controller.ts
import { Controller, Get } from '@nestjs/common';
import { HealthCheck, HealthCheckService, PrismaHealthIndicator } from '@nestjs/terminus';

@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private db: PrismaHealthIndicator,
    private redis: RedisHealthIndicator,
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.db.pingCheck('database'),
      () => this.redis.pingCheck('redis'),
    ]);
  }

  @Get('ready')
  @HealthCheck()
  readiness() {
    return this.health.check([
      () => this.db.pingCheck('database'),
      () => this.redis.pingCheck('redis'),
    ]);
  }

  @Get('live')
  liveness() {
    return { status: 'ok' };
  }
}
```

### 9.4 å¯åŠ¨å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
npm install

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npx prisma generate

# æ•°æ®åº“è¿ç§»
npx prisma migrate deploy

# å¼€å‘æ¨¡å¼
npm run start:dev

# ç”Ÿäº§æ„å»º
npm run build

# ç”Ÿäº§è¿è¡Œ
npm run start:prod

# è¿è¡Œæµ‹è¯•
npm run test
npm run test:e2e
```

---

## ğŸ“ å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒ

1. **æ¨¡å—åŒ–è®¾è®¡**
   - æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹ç›®å½•
   - ä½¿ç”¨ä¾èµ–æ³¨å…¥
   - éµå¾ª SOLID åŸåˆ™

2. **ç±»å‹å®‰å…¨**
   - ä½¿ç”¨ Zod å®šä¹‰æ‰€æœ‰ Schema
   - é¿å…ä½¿ç”¨ any
   - ä½¿ç”¨ z.infer æ¨å¯¼ç±»å‹

3. **é”™è¯¯å¤„ç†**
   - ç»Ÿä¸€å¼‚å¸¸è¿‡æ»¤å™¨
   - è§„èŒƒåŒ–é”™è¯¯ç 
   - è¯¦ç»†é”™è¯¯æ—¥å¿—

4. **å®‰å…¨ä¼˜å…ˆ**
   - æ‰€æœ‰è¾“å…¥å¿…é¡»éªŒè¯
   - æ•æ„Ÿæ•°æ®å¿…é¡»è„±æ•
   - å…³é”®æ“ä½œå¿…é¡»å®¡è®¡

### Git æäº¤è§„èŒƒ

```
feat: æ–°åŠŸèƒ½
fix: ä¿®å¤ bug
docs: æ–‡æ¡£æ›´æ–°
style: ä»£ç æ ¼å¼
refactor: é‡æ„
test: æµ‹è¯•
chore: æ„å»º/å·¥å…·
```

---

> ğŸ“Œ æœ¬æ–‡æ¡£å°†éšé¡¹ç›®å¼€å‘æŒç»­æ›´æ–°
