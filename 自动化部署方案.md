# 图文生成小程序 - 自动化部署方案

> 版本：v1.0  
> 更新日期：2026-01-25  
> 目标：实现代码推送后自动构建、测试、部署到云平台

---

## 📋 目录

1. [云平台选型](#1-云平台选型)
2. [部署架构](#2-部署架构)
3. [CI/CD 流程](#3-cicd-流程)
4. [GitHub Actions 配置](#4-github-actions-配置)
5. [Docker 配置](#5-docker-配置)
6. [云平台部署指南](#6-云平台部署指南)
7. [海外平台部署指南](#7-海外平台部署指南)
8. [监控与告警](#8-监控与告警)
9. [回滚策略](#9-回滚策略)

---

## 1. 云平台选型

### 1.1 国内平台对比

| 平台 | 优势 | 劣势 | 适合场景 | 月费参考 |
|------|------|------|----------|----------|
| **腾讯云** | 微信生态集成好、国内访问快 | 海外访问慢 | 微信小程序首选 | ¥100+ |
| **阿里云** | 稳定、服务全面 | 价格较高 | 企业级应用 | ¥150+ |

### 1.2 海外平台对比（性价比高）⭐

| 平台 | 免费额度 | 付费起步 | 特点 | 推荐指数 |
|------|----------|----------|------|----------|
| **Railway** | $5/月额度 | $5/月 | 超简单、一键数据库 | ⭐⭐⭐⭐⭐ |
| **Render** | 750小时/月 | $7/月 | 免费 PostgreSQL | ⭐⭐⭐⭐⭐ |
| **Fly.io** | 3个小机器 | $5/月 | 全球节点、Docker | ⭐⭐⭐⭐ |
| **Vercel** | 无限静态 | $20/月 | 前端首选 | ⭐⭐⭐⭐⭐ |
| **Zeabur** | 免费层 | $5/月 | 中文友好 | ⭐⭐⭐⭐ |
| **Supabase** | 免费数据库 | $25/月 | PostgreSQL + Auth | ⭐⭐⭐⭐ |
| **Upstash** | 10k请求/天 | $10/月 | Serverless Redis | ⭐⭐⭐⭐ |
| **Cloudflare R2** | 10GB存储 | $0.015/GB | 零出口费用 | ⭐⭐⭐⭐⭐ |

### 1.3 推荐组合

#### 🏆 本项目采用组合（前端海外 + 后端国内）⭐
```
┌─────────────────────────────────────────────────────────────┐
│            ✅ 最终选择：混合部署方案                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  前端（Admin）    → Vercel（免费，全球 CDN 加速）           │
│  后端（Server）   → 腾讯云轻量服务器 + Docker               │
│  数据库           → 腾讯云 PostgreSQL                       │
│  Redis           → 腾讯云 Redis                            │
│  对象存储         → 腾讯云 COS（微信生态集成）               │
│                                                             │
│  💰 总成本：¥100-150/月                                     │
│  ✅ 优势：后端国内访问快、前端全球加速、部署简单             │
└─────────────────────────────────────────────────────────────┘
```

**为什么选择这个组合？**
- 🎯 **后端国内部署**：微信小程序用户在国内，API 响应速度快
- 🌐 **前端 Vercel**：管理后台无需备案，全球 CDN 加速，部署极简
- 💰 **成本可控**：腾讯云轻量服务器性价比高，Vercel 免费额度足够
- 🔗 **微信生态**：COS 与微信小程序无缝集成

#### 💰 备选：纯海外组合（$5-7/月）
```
┌─────────────────────────────────────────────────────────────┐
│                   💰 省钱组合（$5-7/月）                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  前端（Admin）    → Vercel（免费）                          │
│  后端（Server）   → Railway / Render（$5-7/月）            │
│  数据库           → Railway PostgreSQL（包含）              │
│  Redis           → Railway Redis（包含）                   │
│  对象存储         → Cloudflare R2（免费 10GB）              │
│                                                             │
│  ⚠️ 注意：国内访问可能较慢                                   │
└─────────────────────────────────────────────────────────────┘
```

#### 🏢 备选：纯国内组合（¥150-250/月）
```
┌─────────────────────────────────────────────────────────────┐
│                  🇨🇳 纯国内组合（¥150-250/月）               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  前端（Admin）    → 腾讯云静态托管                          │
│  后端（Server）   → 腾讯云轻量服务器 + Docker               │
│  数据库           → 腾讯云 PostgreSQL                       │
│  Redis           → 腾讯云 Redis                            │
│  对象存储         → 腾讯云 COS                              │
│                                                             │
│  ⚠️ 注意：前端需要备案                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 部署架构

### 2.1 整体架构图

```
                         ┌──────────────┐
                         │   GitHub     │
                         │  Repository  │
                         └──────┬───────┘
                                │ push / merge
                                ▼
                         ┌──────────────┐
                         │   GitHub     │
                         │   Actions    │
                         └──────┬───────┘
                                │
           ┌────────────────────┼────────────────────┐
           │                    │                    │
           ▼                    ▼                    ▼
    ┌────────────┐       ┌────────────┐       ┌────────────┐
    │   Lint     │       │   Test     │       │   Build    │
    │   Check    │       │   Unit     │       │   Docker   │
    └─────┬──────┘       └─────┬──────┘       └─────┬──────┘
          │                    │                    │
          └────────────────────┼────────────────────┘
                               │ All Pass
                               ▼
              ┌────────────────┴────────────────┐
              │                                 │
              ▼                                 ▼
    ┌─────────────────┐               ┌─────────────────┐
    │     Vercel      │               │   腾讯云容器    │
    │   （前端Admin）  │               │    Registry    │
    │    🌐 海外       │               │    🇨🇳 国内     │
    └─────────────────┘               └────────┬────────┘
                                               │
                                               ▼
                                      ┌─────────────────┐
                                      │  腾讯云轻量服务器 │
                                      │   （后端Server） │
                                      └────────┬────────┘
                                               │
                        ┌──────────────────────┼──────────────────────┐
                        │                      │                      │
                        ▼                      ▼                      ▼
              ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
              │   PostgreSQL    │    │     Redis       │    │    腾讯云 COS    │
              │   腾讯云数据库   │    │   腾讯云缓存    │    │    对象存储      │
              └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 部署拓扑说明

| 组件 | 部署位置 | 说明 |
|------|----------|------|
| **Admin 前端** | Vercel（海外） | 免费、自动部署、全球 CDN |
| **Server 后端** | 腾讯云轻量服务器（国内） | Docker 部署，国内访问快 |
| **PostgreSQL** | 腾讯云数据库（国内） | 高可用、自动备份 |
| **Redis** | 腾讯云 Redis（国内） | 缓存、会话管理 |
| **COS 存储** | 腾讯云 COS（国内） | 图片存储、微信生态集成 |

### 2.2 分支策略

```
main (生产环境)
  │
  ├── develop (开发环境)
  │     │
  │     ├── feature/xxx (功能分支)
  │     ├── feature/yyy
  │     └── ...
  │
  └── hotfix/xxx (紧急修复)
```

| 分支 | 触发部署 | 目标环境 |
|------|----------|----------|
| `main` | 自动 | 生产环境 |
| `develop` | 自动 | 测试环境 |
| `feature/*` | 手动 | 开发环境 |
| `hotfix/*` | 自动 | 生产环境 |

---

## 3. CI/CD 流程

### 3.1 完整流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CI/CD Pipeline                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐  │
│  │  Lint   │──▶│  Test   │──▶│  Build  │──▶│  Push   │──▶│ Deploy  │  │
│  │  Check  │   │  Unit   │   │  Image  │   │  Image  │   │  Server │  │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘  │
│       │             │             │             │             │        │
│       ▼             ▼             ▼             ▼             ▼        │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐  │
│  │ ESLint  │   │  Jest   │   │ Docker  │   │Registry │   │  SSH /  │  │
│  │Prettier │   │ Vitest  │   │  Build  │   │  Push   │   │ Webhook │  │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 各阶段说明

| 阶段 | 说明 | 失败处理 |
|------|------|----------|
| **Lint** | 代码规范检查 | 阻止合并 |
| **Test** | 单元测试 + E2E 测试 | 阻止合并 |
| **Build** | 构建 Docker 镜像 | 阻止部署 |
| **Push** | 推送镜像到仓库 | 阻止部署 |
| **Deploy** | 部署到服务器 | 触发告警 |

---

## 4. GitHub Actions 配置

### 4.1 目录结构

```
.github/
├── workflows/
│   ├── ci.yml              # CI 检查（所有分支）
│   ├── deploy-server.yml   # Server 部署
│   ├── deploy-admin.yml    # Admin 部署
│   └── release.yml         # 版本发布
└── actions/
    └── setup/              # 自定义 Action
        └── action.yml
```

### 4.2 CI 检查工作流

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ==================== 代码检查 ====================
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies (Server)
        run: npm ci
        working-directory: ./server

      - name: Install Dependencies (Admin)
        run: npm ci
        working-directory: ./admin

      - name: Lint Server
        run: npm run lint
        working-directory: ./server

      - name: Lint Admin
        run: npm run lint
        working-directory: ./admin

  # ==================== 单元测试 ====================
  test:
    name: Unit Test
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        working-directory: ./server

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: ./server

      - name: Run Migrations
        run: npx prisma migrate deploy
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Run Tests
        run: npm run test:cov
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-for-ci-testing-only

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./server/coverage/lcov.info
          fail_ci_if_error: true

  # ==================== 构建检查 ====================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build Server
        run: |
          npm ci
          npm run build
        working-directory: ./server

      - name: Build Admin
        run: |
          npm ci
          npm run build
        working-directory: ./admin
```

### 4.3 Server 部署工作流

```yaml
# .github/workflows/deploy-server.yml
name: Deploy Server

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:  # 支持手动触发

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/server

jobs:
  # ==================== 构建并推送镜像 ====================
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================== 部署到服务器 ====================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/app
            
            # 拉取最新镜像
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # 停止旧容器
            docker-compose stop server
            
            # 备份当前版本（用于回滚）
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                       ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backup || true
            
            # 启动新容器
            docker-compose up -d server
            
            # 健康检查
            sleep 10
            curl -f http://localhost:3000/health || exit 1
            
            # 清理旧镜像
            docker image prune -f

      - name: Notify Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "✅ Server 部署成功",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*✅ Server 部署成功*\n环境: Production\n提交: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "❌ Server 部署失败",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*❌ Server 部署失败*\n环境: Production\n请检查日志: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

### 4.4 Admin 部署工作流（Vercel）

```yaml
# .github/workflows/deploy-admin.yml
name: Deploy Admin

on:
  push:
    branches: [main]
    paths:
      - 'admin/**'
      - '.github/workflows/deploy-admin.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./admin/package-lock.json

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./admin

      - name: Build
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./admin

      - name: Deploy
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./admin
```

### 4.5 数据库迁移工作流

```yaml
# .github/workflows/migrate.yml
name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  migrate:
    name: Run Migration
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci
        working-directory: ./server

      - name: Run Migration
        run: npx prisma migrate deploy
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Notify
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "🗄️ 数据库迁移完成 - ${{ github.event.inputs.environment }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

---

## 5. Docker 配置

### 5.1 Server Dockerfile

```dockerfile
# server/Dockerfile

# ==================== 构建阶段 ====================
FROM node:20-alpine AS builder

WORKDIR /app

# 安装构建依赖
RUN apk add --no-cache python3 make g++

# 复制依赖文件
COPY package*.json ./
COPY prisma ./prisma/

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 生成 Prisma 客户端
RUN npx prisma generate

# 构建应用
RUN npm run build

# 移除开发依赖
RUN npm prune --production

# ==================== 运行阶段 ====================
FROM node:20-alpine AS runner

WORKDIR /app

# 安全：创建非 root 用户
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nestjs

# 复制构建产物
COPY --from=builder --chown=nestjs:nodejs /app/dist ./dist
COPY --from=builder --chown=nestjs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nestjs:nodejs /app/package*.json ./
COPY --from=builder --chown=nestjs:nodejs /app/prisma ./prisma

# 切换到非 root 用户
USER nestjs

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1

# 启动命令
CMD ["node", "dist/main.js"]
```

### 5.2 Admin Dockerfile

```dockerfile
# admin/Dockerfile

# ==================== 构建阶段 ====================
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

# 构建参数
ARG VITE_API_BASE_URL
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL

RUN npm run build

# ==================== 运行阶段 ====================
FROM nginx:alpine AS runner

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 暴露端口
EXPOSE 80

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1

CMD ["nginx", "-g", "daemon off;"]
```

### 5.3 Nginx 配置

```nginx
# admin/nginx.conf
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml;

    # 健康检查
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # 静态资源缓存
    location /assets {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理（如果需要）
    location /api {
        proxy_pass http://server:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 5.4 Docker Compose（生产环境）

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # ==================== 后端服务 ====================
  server:
    image: ghcr.io/your-repo/server:latest
    container_name: app-server
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - WECHAT_APPID=${WECHAT_APPID}
      - WECHAT_SECRET=${WECHAT_SECRET}
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==================== 任务处理器 ====================
  worker:
    image: ghcr.io/your-repo/server:latest
    container_name: app-worker
    restart: unless-stopped
    command: ["node", "dist/worker.js"]
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - AI_SERVICE_URL=${AI_SERVICE_URL}
    depends_on:
      - redis
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # ==================== 管理后台 ====================
  admin:
    image: ghcr.io/your-repo/admin:latest
    container_name: app-admin
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - app-network

  # ==================== Redis ====================
  redis:
    image: redis:7-alpine
    container_name: app-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== Nginx 反向代理 ====================
  nginx:
    image: nginx:alpine
    container_name: app-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - server
      - admin
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  redis_data:
```

---

## 6. 云平台部署指南

### 6.1 腾讯云轻量服务器部署

#### 6.1.1 服务器初始化脚本

```bash
#!/bin/bash
# init-server.sh - 服务器初始化脚本

set -e

echo "===== 更新系统 ====="
apt-get update && apt-get upgrade -y

echo "===== 安装 Docker ====="
curl -fsSL https://get.docker.com | sh
systemctl enable docker
systemctl start docker

echo "===== 安装 Docker Compose ====="
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
  -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

echo "===== 配置防火墙 ====="
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

echo "===== 创建应用目录 ====="
mkdir -p /opt/app
cd /opt/app

echo "===== 配置 Docker 登录 ====="
# 需要手动配置 GitHub Container Registry 登录
# echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

echo "===== 初始化完成 ====="
```

#### 6.1.2 部署脚本

```bash
#!/bin/bash
# deploy.sh - 部署脚本

set -e

APP_DIR="/opt/app"
COMPOSE_FILE="docker-compose.prod.yml"

cd $APP_DIR

echo "===== 拉取最新镜像 ====="
docker-compose -f $COMPOSE_FILE pull

echo "===== 停止旧服务 ====="
docker-compose -f $COMPOSE_FILE down

echo "===== 运行数据库迁移 ====="
docker-compose -f $COMPOSE_FILE run --rm server npx prisma migrate deploy

echo "===== 启动新服务 ====="
docker-compose -f $COMPOSE_FILE up -d

echo "===== 等待服务启动 ====="
sleep 15

echo "===== 健康检查 ====="
curl -f http://localhost:3000/health || exit 1

echo "===== 清理旧镜像 ====="
docker image prune -f

echo "===== 部署完成 ====="
docker-compose -f $COMPOSE_FILE ps
```

### 6.2 Vercel 部署（Admin）

#### 6.2.1 Vercel 配置文件

```json
// admin/vercel.json
{
  "version": 2,
  "name": "iwan-admin",
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    }
  ],
  "routes": [
    {
      "src": "/assets/(.*)",
      "headers": {
        "Cache-Control": "public, max-age=31536000, immutable"
      }
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "env": {
    "VITE_API_BASE_URL": "@api_base_url"
  }
}
```

### 6.3 Railway 部署（快速方案）

#### 6.3.1 Railway 配置

```toml
# railway.toml
[build]
builder = "dockerfile"
dockerfilePath = "./server/Dockerfile"

[deploy]
startCommand = "node dist/main.js"
healthcheckPath = "/health"
healthcheckTimeout = 30
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 5
```

#### 6.3.2 环境变量配置

在 Railway Dashboard 中配置：

```
NODE_ENV=production
DATABASE_URL=postgresql://...
REDIS_URL=redis://...
JWT_SECRET=your-secret
WECHAT_APPID=wx...
WECHAT_SECRET=...
```

---

## 7. 海外平台部署指南

### 7.1 Railway 部署（⭐ 最推荐）

Railway 是最简单的全栈部署平台，5分钟即可完成部署。

#### 7.1.1 特点
- ✅ 一键部署 PostgreSQL、Redis、MongoDB
- ✅ 自动 HTTPS
- ✅ GitHub 集成自动部署
- ✅ $5/月免费额度
- ✅ 支持 Docker、Node.js、Python

#### 7.1.2 部署步骤

```bash
# 1. 安装 Railway CLI
npm install -g @railway/cli

# 2. 登录
railway login

# 3. 初始化项目
cd server
railway init

# 4. 添加 PostgreSQL
railway add --plugin postgresql

# 5. 添加 Redis
railway add --plugin redis

# 6. 部署
railway up
```

#### 7.1.3 Railway 配置文件

```toml
# server/railway.toml
[build]
builder = "dockerfile"
dockerfilePath = "./Dockerfile"

[deploy]
startCommand = "node dist/main.js"
healthcheckPath = "/health"
healthcheckTimeout = 30
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 5

[service]
internalPort = 3000
```

#### 7.1.4 环境变量（自动注入）

Railway 会自动注入数据库连接变量：
```bash
DATABASE_URL          # PostgreSQL 连接字符串
REDIS_URL             # Redis 连接字符串
RAILWAY_ENVIRONMENT   # 环境名称
PORT                  # 端口号
```

手动配置的变量：
```bash
NODE_ENV=production
JWT_SECRET=your-super-secret-key
WECHAT_APPID=wx1234567890
WECHAT_SECRET=your-wechat-secret
```

#### 7.1.5 GitHub Actions 自动部署

```yaml
# .github/workflows/deploy-railway.yml
name: Deploy to Railway

on:
  push:
    branches: [main]
    paths:
      - 'server/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy
        run: railway up --service server
        working-directory: ./server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

---

### 7.2 Render 部署

Render 提供慷慨的免费层，适合预算有限的项目。

#### 7.2.1 特点
- ✅ 750小时/月免费
- ✅ 免费 PostgreSQL（90天）
- ✅ 自动从 GitHub 部署
- ✅ 免费 SSL
- ✅ 支持 Cron Jobs

#### 7.2.2 render.yaml 配置

```yaml
# render.yaml
services:
  # 后端 API
  - type: web
    name: iwan-server
    env: docker
    dockerfilePath: ./server/Dockerfile
    dockerContext: ./server
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: iwan-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: iwan-redis
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
    healthCheckPath: /health
    autoDeploy: true

  # 管理后台
  - type: web
    name: iwan-admin
    env: static
    buildCommand: npm run build
    staticPublishPath: ./admin/dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

databases:
  - name: iwan-db
    databaseName: iwan
    plan: free  # 免费版

# Redis
  - type: redis
    name: iwan-redis
    plan: free
    maxmemoryPolicy: allkeys-lru
```

#### 7.2.3 GitHub Actions 部署

```yaml
# .github/workflows/deploy-render.yml
name: Deploy to Render

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
```

---

### 7.3 Fly.io 部署

Fly.io 支持全球边缘部署，适合需要低延迟的应用。

#### 7.3.1 特点
- ✅ 3个小机器永久免费
- ✅ 全球边缘节点（包括亚洲）
- ✅ Docker 原生支持
- ✅ 内置 PostgreSQL、Redis
- ✅ 自动扩缩容

#### 7.3.2 部署步骤

```bash
# 1. 安装 Fly CLI
curl -L https://fly.io/install.sh | sh

# 2. 登录
fly auth login

# 3. 初始化应用
cd server
fly launch

# 4. 创建 PostgreSQL
fly postgres create --name iwan-db

# 5. 附加数据库
fly postgres attach iwan-db

# 6. 创建 Redis
fly redis create --name iwan-redis

# 7. 部署
fly deploy
```

#### 7.3.3 fly.toml 配置

```toml
# server/fly.toml
app = "iwan-server"
primary_region = "hkg"  # 香港节点

[build]
  dockerfile = "Dockerfile"

[env]
  NODE_ENV = "production"
  PORT = "3000"

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1

[[services]]
  protocol = "tcp"
  internal_port = 3000

  [[services.ports]]
    port = 80
    handlers = ["http"]

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  [[services.http_checks]]
    interval = "10s"
    timeout = "2s"
    path = "/health"
    method = "GET"

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512
```

#### 7.3.4 GitHub Actions 部署

```yaml
# .github/workflows/deploy-fly.yml
name: Deploy to Fly.io

on:
  push:
    branches: [main]
    paths:
      - 'server/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy
        run: flyctl deploy --remote-only
        working-directory: ./server
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
```

---

### 7.4 Vercel 部署（前端）

Vercel 是前端部署的最佳选择。

#### 7.4.1 特点
- ✅ 个人项目完全免费
- ✅ 极速全球 CDN
- ✅ 自动 HTTPS
- ✅ 预览部署（每个 PR）
- ✅ Edge Functions

#### 7.4.2 vercel.json 配置

```json
{
  "version": 2,
  "name": "iwan-admin",
  "framework": "vue",
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "routes": [
    {
      "src": "/assets/(.*)",
      "headers": {
        "Cache-Control": "public, max-age=31536000, immutable"
      }
    },
    {
      "handle": "filesystem"
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-Content-Type-Options", "value": "nosniff" }
      ]
    }
  ]
}
```

#### 7.4.3 部署命令

```bash
# 安装 Vercel CLI
npm install -g vercel

# 登录
vercel login

# 部署预览
vercel

# 部署生产
vercel --prod
```

---

### 7.5 Supabase（免费 PostgreSQL）

Supabase 提供免费的 PostgreSQL 数据库。

#### 7.5.1 特点
- ✅ 500MB 存储免费
- ✅ 内置 Auth、Storage
- ✅ 实时数据库订阅
- ✅ 自动 API 生成

#### 7.5.2 连接配置

```typescript
// 环境变量
DATABASE_URL=postgresql://postgres:[password]@db.[project].supabase.co:5432/postgres
```

---

### 7.6 Upstash（免费 Redis）

Upstash 提供 Serverless Redis。

#### 7.6.1 特点
- ✅ 10,000 请求/天免费
- ✅ REST API 访问
- ✅ 全球边缘部署
- ✅ 按请求计费

#### 7.6.2 连接配置

```typescript
// 使用 @upstash/redis
import { Redis } from '@upstash/redis';

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});
```

---

### 7.7 Cloudflare R2（免费存储）

Cloudflare R2 提供 S3 兼容的对象存储，零出口费用。

#### 7.7.1 特点
- ✅ 10GB 存储免费
- ✅ 零出口流量费用
- ✅ S3 兼容 API
- ✅ 全球 CDN

#### 7.7.2 配置示例

```typescript
// src/modules/storage/r2.config.ts
import { S3Client } from '@aws-sdk/client-s3';

export const r2Client = new S3Client({
  region: 'auto',
  endpoint: `https://${process.env.CF_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,
  },
});
```

---

### 7.8 完整部署流程示例

以下是使用 Railway + Vercel + Cloudflare R2 的完整部署流程：

```yaml
# .github/workflows/deploy-full.yml
name: Full Stack Deploy

on:
  push:
    branches: [main]

jobs:
  # 测试
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
        working-directory: ./server
      - run: npm test
        working-directory: ./server

  # 部署后端到 Railway
  deploy-server:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm install -g @railway/cli
      - run: railway up --service server
        working-directory: ./server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # 部署前端到 Vercel
  deploy-admin:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g vercel
      - run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./admin
      - run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./admin
      - run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./admin

  # 通知
  notify:
    needs: [deploy-server, deploy-admin]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Success
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text": "✅ 部署成功！"}'
      - name: Notify Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text": "❌ 部署失败，请检查！"}'
```

---

## 8. 监控与告警

### 8.1 健康检查端点

```typescript
// src/health/health.controller.ts
@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private db: PrismaHealthIndicator,
    private redis: RedisHealthIndicator,
    private disk: DiskHealthIndicator,
    private memory: MemoryHealthIndicator,
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      // 数据库检查
      () => this.db.pingCheck('database'),
      // Redis 检查
      () => this.redis.pingCheck('redis'),
      // 磁盘检查（阈值 90%）
      () => this.disk.checkStorage('storage', { 
        thresholdPercent: 0.9, 
        path: '/' 
      }),
      // 内存检查（阈值 1GB）
      () => this.memory.checkHeap('memory_heap', 1024 * 1024 * 1024),
    ]);
  }
}
```

### 8.2 应用监控配置

```typescript
// src/shared/monitoring/monitoring.service.ts
import * as Sentry from '@sentry/node';

@Injectable()
export class MonitoringService {
  constructor() {
    // 初始化 Sentry
    if (process.env.SENTRY_DSN) {
      Sentry.init({
        dsn: process.env.SENTRY_DSN,
        environment: process.env.NODE_ENV,
        tracesSampleRate: 0.1,
      });
    }
  }

  captureException(error: Error, context?: any) {
    Sentry.captureException(error, {
      extra: context,
    });
  }

  captureMessage(message: string, level: 'info' | 'warning' | 'error' = 'info') {
    Sentry.captureMessage(message, level);
  }
}
```

### 7.3 日志配置

```typescript
// src/shared/logger/logger.config.ts
import * as winston from 'winston';

export const loggerConfig = {
  transports: [
    // 控制台输出
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.colorize(),
        winston.format.printf(({ timestamp, level, message, ...meta }) => {
          return `${timestamp} [${level}]: ${message} ${Object.keys(meta).length ? JSON.stringify(meta) : ''}`;
        }),
      ),
    }),
    // 文件输出（生产环境）
    ...(process.env.NODE_ENV === 'production' ? [
      new winston.transports.File({
        filename: '/var/log/app/error.log',
        level: 'error',
        maxsize: 10 * 1024 * 1024,  // 10MB
        maxFiles: 5,
      }),
      new winston.transports.File({
        filename: '/var/log/app/combined.log',
        maxsize: 10 * 1024 * 1024,
        maxFiles: 10,
      }),
    ] : []),
  ],
};
```

### 7.4 告警通知

```typescript
// src/shared/alert/alert.service.ts
@Injectable()
export class AlertService {
  constructor(private readonly httpService: HttpService) {}

  // 发送钉钉告警
  async sendDingTalkAlert(title: string, content: string) {
    const webhook = process.env.DINGTALK_WEBHOOK;
    if (!webhook) return;

    await this.httpService.axiosRef.post(webhook, {
      msgtype: 'markdown',
      markdown: {
        title,
        text: `### ${title}\n${content}\n\n时间: ${new Date().toLocaleString('zh-CN')}`,
      },
    });
  }

  // 发送企业微信告警
  async sendWechatWorkAlert(title: string, content: string) {
    const webhook = process.env.WECHAT_WORK_WEBHOOK;
    if (!webhook) return;

    await this.httpService.axiosRef.post(webhook, {
      msgtype: 'markdown',
      markdown: {
        content: `### ${title}\n${content}`,
      },
    });
  }
}
```

---

## 8. 回滚策略

### 8.1 快速回滚脚本

```bash
#!/bin/bash
# rollback.sh - 回滚脚本

set -e

APP_DIR="/opt/app"
COMPOSE_FILE="docker-compose.prod.yml"

cd $APP_DIR

echo "===== 停止当前服务 ====="
docker-compose -f $COMPOSE_FILE stop server worker

echo "===== 切换到备份镜像 ====="
docker tag ghcr.io/your-repo/server:backup ghcr.io/your-repo/server:latest

echo "===== 启动服务 ====="
docker-compose -f $COMPOSE_FILE up -d server worker

echo "===== 健康检查 ====="
sleep 10
curl -f http://localhost:3000/health || exit 1

echo "===== 回滚完成 ====="
```

### 8.2 数据库回滚

```bash
#!/bin/bash
# rollback-db.sh - 数据库回滚

# 列出可用的迁移版本
npx prisma migrate status

# 回滚到指定版本（需要手动编写回滚 SQL）
# npx prisma migrate resolve --rolled-back MIGRATION_NAME
```

### 8.3 GitHub Actions 回滚工作流

```yaml
# .github/workflows/rollback.yml
name: Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback to (commit SHA or tag)'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Rollback via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/app
            
            # 拉取指定版本
            docker pull ghcr.io/${{ github.repository }}/server:${{ github.event.inputs.version }}
            
            # 更新标签
            docker tag ghcr.io/${{ github.repository }}/server:${{ github.event.inputs.version }} \
                       ghcr.io/${{ github.repository }}/server:latest
            
            # 重启服务
            docker-compose -f docker-compose.prod.yml up -d server worker
            
            # 健康检查
            sleep 10
            curl -f http://localhost:3000/health
```

---

## 📝 配置清单

### GitHub Secrets 配置

| Secret 名称 | 说明 |
|-------------|------|
| `SERVER_HOST` | 服务器 IP 地址 |
| `SERVER_USER` | SSH 用户名 |
| `SERVER_SSH_KEY` | SSH 私钥 |
| `DATABASE_URL` | 数据库连接字符串 |
| `REDIS_URL` | Redis 连接字符串 |
| `JWT_SECRET` | JWT 密钥 |
| `WECHAT_APPID` | 微信小程序 AppID |
| `WECHAT_SECRET` | 微信小程序 Secret |
| `VERCEL_TOKEN` | Vercel 部署 Token |
| `SLACK_WEBHOOK` | Slack 通知 Webhook |
| `SENTRY_DSN` | Sentry DSN |

### 部署检查清单

- [ ] GitHub Secrets 配置完成
- [ ] 服务器初始化完成
- [ ] Docker 登录配置完成
- [ ] SSL 证书配置完成
- [ ] 数据库服务就绪
- [ ] Redis 服务就绪
- [ ] 对象存储配置完成
- [ ] 监控告警配置完成
- [ ] 备份策略配置完成

---

> 📌 本文档将随项目部署实践持续更新
