# 🚀 自动化部署指南

> 本文档指导如何启用项目的自动化部署功能

---

## 📋 目录

1. [前置准备](#1-前置准备)
2. [推送代码到 GitHub](#2-推送代码到-github)
3. [配置 GitHub Secrets](#3-配置-github-secrets)
4. [前端部署（Vercel）](#4-前端部署vercel)
5. [后端部署（腾讯云）](#5-后端部署腾讯云)
6. [验证部署](#6-验证部署)
7. [常用操作](#7-常用操作)

---

## 1. 前置准备

### 1.1 所需账号

| 服务 | 用途 | 注册地址 |
|------|------|----------|
| GitHub | 代码托管 + CI/CD | https://github.com |
| Vercel | 前端托管 | https://vercel.com |
| 腾讯云 | 后端服务器 | https://cloud.tencent.com |

### 1.2 本地环境

```bash
# 检查 Git
git --version

# 检查 Node.js (需要 v20+)
node --version

# 安装 Vercel CLI
npm install -g vercel
```

---

## 2. 推送代码到 GitHub

### 2.1 创建 GitHub 仓库

1. 访问 https://github.com/new
2. 填写仓库名称：`image_word`
3. 选择 **Private**（私有仓库）
4. 点击 **Create repository**

### 2.2 初始化并推送

```bash
# 进入项目目录
cd /path/to/image_word

# 初始化 Git 仓库
git init

# 添加所有文件
git add .

# 提交
git commit -m "🎉 初始化项目"

# 添加远程仓库（替换为你的仓库地址）
git remote add origin https://github.com/你的用户名/image_word.git

# 推送到 main 分支
git branch -M main
git push -u origin main
```

---

## 3. 配置 GitHub Secrets

### 3.1 进入配置页面

1. 打开 GitHub 仓库页面
2. 点击 **Settings** → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**

### 3.2 必需的 Secrets

| Secret 名称 | 说明 | 示例值 |
|-------------|------|--------|
| `VERCEL_TOKEN` | Vercel API Token | `xxxxxxxx` |
| `SERVER_HOST` | 服务器 IP 地址 | `123.45.67.89` |
| `SERVER_USER` | SSH 用户名 | `root` |
| `SERVER_SSH_KEY` | SSH 私钥（完整内容） | `-----BEGIN RSA PRIVATE KEY-----...` |
| `DATABASE_URL` | PostgreSQL 连接字符串 | `postgresql://user:pass@host:5432/db` |
| `REDIS_URL` | Redis 连接字符串 | `redis://host:6379` |

### 3.3 获取各项 Secret

#### Vercel Token
1. 访问 https://vercel.com/account/tokens
2. 点击 **Create**
3. 输入名称，点击 **Create Token**
4. 复制 Token

#### SSH 私钥
```bash
# 生成 SSH 密钥（如果没有）
ssh-keygen -t rsa -b 4096 -C "deploy@github"

# 查看私钥内容
cat ~/.ssh/id_rsa

# 复制公钥到服务器
ssh-copy-id root@你的服务器IP
```

### 3.4 可选的 Secrets（通知）

| Secret 名称 | 说明 |
|-------------|------|
| `SLACK_WEBHOOK` | Slack 通知 Webhook URL |
| `DINGTALK_WEBHOOK` | 钉钉机器人 Webhook URL |

---

## 4. 前端部署（Vercel）

### 4.1 首次部署

```bash
# 进入 admin 目录
cd admin

# 登录 Vercel
vercel login

# 关联项目
vercel link

# 设置环境变量
vercel env add VITE_API_BASE_URL production
# 输入值：https://api.你的域名.com

# 部署
vercel --prod
```

### 4.2 自动部署

首次部署后，每次推送到 `main` 分支的 `admin/**` 文件变更都会自动触发部署。

### 4.3 自定义域名（可选）

1. 在 Vercel Dashboard 打开项目
2. 点击 **Settings** → **Domains**
3. 添加自定义域名
4. 按提示配置 DNS

---

## 5. 后端部署（腾讯云）

### 5.1 购买服务器

推荐配置：
- **腾讯云轻量应用服务器**
- CPU: 2核
- 内存: 4GB
- 带宽: 5Mbps
- 系统: Ubuntu 22.04

### 5.2 初始化服务器

```bash
# SSH 连接到服务器
ssh root@你的服务器IP

# 下载并执行初始化脚本
curl -fsSL https://raw.githubusercontent.com/你的用户名/image_word/main/scripts/init-server.sh -o init.sh
chmod +x init.sh
./init.sh
```

### 5.3 配置 Docker 登录

```bash
# 登录 GitHub Container Registry
echo $GITHUB_TOKEN | docker login ghcr.io -u 你的GitHub用户名 --password-stdin
```

### 5.4 创建环境配置

```bash
# 进入应用目录
cd /opt/app

# 复制环境变量模板
cp env.example .env

# 编辑环境变量
nano .env
```

### 5.5 启动服务

```bash
# 拉取并启动服务
docker-compose -f docker-compose.prod.yml up -d

# 查看状态
docker-compose -f docker-compose.prod.yml ps
```

---

## 6. 验证部署

### 6.1 检查 CI/CD 状态

1. 访问 GitHub 仓库
2. 点击 **Actions** 标签
3. 查看工作流运行状态

### 6.2 检查前端

```bash
# 访问 Vercel 分配的域名
curl https://你的项目.vercel.app
```

### 6.3 检查后端

```bash
# 健康检查
curl https://api.你的域名.com/health

# 预期返回
# {"status":"ok","info":{"database":{"status":"up"},"redis":{"status":"up"}}}
```

---

## 7. 常用操作

### 7.1 手动触发部署

```bash
# 在 GitHub Actions 页面
# 选择对应的 workflow → Run workflow
```

### 7.2 查看日志

```bash
# SSH 到服务器
ssh root@你的服务器IP

# 查看容器日志
docker logs -f app-server

# 查看所有服务状态
docker-compose -f /opt/app/docker-compose.prod.yml ps
```

### 7.3 回滚版本

**方式一：GitHub Actions**
1. 进入 Actions → Rollback
2. 点击 Run workflow
3. 输入要回滚的版本（commit SHA）

**方式二：手动回滚**
```bash
ssh root@你的服务器IP
cd /opt/app
./rollback.sh
```

### 7.4 数据库迁移

```bash
# 通过 GitHub Actions
# Actions → Database Migration → Run workflow → 选择环境
```

### 7.5 更新配置

```bash
# SSH 到服务器
ssh root@你的服务器IP

# 编辑环境变量
nano /opt/app/.env

# 重启服务
cd /opt/app
docker-compose -f docker-compose.prod.yml restart
```

---

## 📝 部署检查清单

部署前请确认以下事项：

- [ ] GitHub 仓库已创建
- [ ] GitHub Secrets 已配置完成
  - [ ] `VERCEL_TOKEN`
  - [ ] `SERVER_HOST`
  - [ ] `SERVER_USER`
  - [ ] `SERVER_SSH_KEY`
  - [ ] `DATABASE_URL`
  - [ ] `REDIS_URL`
- [ ] Vercel 项目已关联
- [ ] 服务器已初始化
  - [ ] Docker 已安装
  - [ ] Docker Compose 已安装
  - [ ] 防火墙已配置
- [ ] 数据库服务已就绪
- [ ] Redis 服务已就绪
- [ ] SSL 证书已配置（如需 HTTPS）

---

## 🔗 相关链接

- [GitHub Actions 文档](https://docs.github.com/en/actions)
- [Vercel 文档](https://vercel.com/docs)
- [Docker 文档](https://docs.docker.com)
- [腾讯云文档](https://cloud.tencent.com/document)

---

## ❓ 常见问题

### Q: GitHub Actions 运行失败？
A: 检查 Secrets 是否正确配置，查看 Actions 日志获取详细错误信息。

### Q: Vercel 部署失败？
A: 检查 `VERCEL_TOKEN` 是否有效，确保 `admin/` 目录下的代码可以正常构建。

### Q: 服务器无法访问？
A: 检查防火墙配置，确保 80/443 端口已开放。

### Q: 容器启动失败？
A: 运行 `docker logs app-server` 查看错误日志。

---

> 📌 如有问题，请查阅 `doc/自动化部署方案.md` 获取更详细的技术说明。
